{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"CLOCs_LQS \u6a21\u5757\u6587\u6863\uff08\u7b97\u5b50\u7ea7\u91cd\u6784\u7248\uff09 \u00b6 \u672c\u7f51\u7ad9\u5c55\u793a\u4e86\u57fa\u4e8e\u7b97\u5b50\uff08operator\uff09\u65b9\u5f0f\u91cd\u6784\u7684 CLOCs_LQS \u878d\u5408\u6a21\u5757\uff0c\u5305\u62ec\uff1a Stage1\uff1a\u5019\u9009\u5339\u914d\uff08Candidate Matching\uff09 Stage2\uff1aPair \u7279\u5f81\u6784\u5efa Stage3\uff1aFusionMLP\uff08Conv1\u00d71 \u5b9e\u73b0\u7684\u70b9\u5bf9\u878d\u5408\u7f51\u7edc\uff09 Stage4\uff1a\u5f97\u5206\u805a\u5408\uff08Score Aggregation\uff09 Stage5\uff1a\u540e\u5904\u7406\uff08IoU3D + NMS\uff09 CLOCs_LQS \u4e3b\u878d\u5408\u6846\u67b6\uff08Framework\uff09 \u6240\u6709\u7b97\u5b50\u5747\u7531 mkdocstrings \u81ea\u52a8\u4ece\u6e90\u4ee3\u7801 docstring \u751f\u6210\u3002 \u6587\u6863\u5bfc\u822a\uff08\u5feb\u901f\u8df3\u8f6c\uff09 \u00b6 Stage1_CandidateMatching.md Stage2_PairFeatureBuilding.md Stage3_FusionMLP.md Stage4_ScoreAggregation.md Stage5_PostProcessing.md CLOCs_LQS_framework.md","title":"\u6587\u6863\u9996\u9875"},{"location":"#clocs_lqs","text":"\u672c\u7f51\u7ad9\u5c55\u793a\u4e86\u57fa\u4e8e\u7b97\u5b50\uff08operator\uff09\u65b9\u5f0f\u91cd\u6784\u7684 CLOCs_LQS \u878d\u5408\u6a21\u5757\uff0c\u5305\u62ec\uff1a Stage1\uff1a\u5019\u9009\u5339\u914d\uff08Candidate Matching\uff09 Stage2\uff1aPair \u7279\u5f81\u6784\u5efa Stage3\uff1aFusionMLP\uff08Conv1\u00d71 \u5b9e\u73b0\u7684\u70b9\u5bf9\u878d\u5408\u7f51\u7edc\uff09 Stage4\uff1a\u5f97\u5206\u805a\u5408\uff08Score Aggregation\uff09 Stage5\uff1a\u540e\u5904\u7406\uff08IoU3D + NMS\uff09 CLOCs_LQS \u4e3b\u878d\u5408\u6846\u67b6\uff08Framework\uff09 \u6240\u6709\u7b97\u5b50\u5747\u7531 mkdocstrings \u81ea\u52a8\u4ece\u6e90\u4ee3\u7801 docstring \u751f\u6210\u3002","title":"CLOCs_LQS \u6a21\u5757\u6587\u6863\uff08\u7b97\u5b50\u7ea7\u91cd\u6784\u7248\uff09"},{"location":"#_1","text":"Stage1_CandidateMatching.md Stage2_PairFeatureBuilding.md Stage3_FusionMLP.md Stage4_ScoreAggregation.md Stage5_PostProcessing.md CLOCs_LQS_framework.md","title":"\u6587\u6863\u5bfc\u822a\uff08\u5feb\u901f\u8df3\u8f6c\uff09"},{"location":"CLOCs_LQS_framework/","text":"CLOCs_LQS Framework\uff08\u878d\u5408\u4e3b\u6846\u67b6\uff09 \u00b6 CLOCs_LQS \u4e3b\u6846\u67b6\u5c06\u6240\u6709 Stage \u4e32\u8054\u8d77\u6765\uff0c\u5f62\u6210\u5b8c\u6574\u7684 2D\u20133D \u878d\u5408\u68c0\u6d4b\u6d41\u7a0b\u3002 \u4e3b\u878d\u5408\u6846\u67b6\uff0c\u5c06 2D/3D \u68c0\u6d4b\u5668\u3001\u5404 Stage \u7b97\u5b50\u4e32\u8054\u5f62\u6210\u5b8c\u6574\u878d\u5408\u6d41\u7a0b\u3002 API \u6587\u6863 \u00b6 CLOCs_LQS_Pipeline \u00b6 Bases: Module CLOCs_LQS \u878d\u5408\u4e3b\u6846\u67b6\uff0c\u5c06 2D \u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u901a\u8fc7\u5019\u9009\u5339\u914d\u548c MLP \u878d\u5408\uff0c\u5f97\u5230\u6700\u7ec8\u7684 3D \u68c0\u6d4b\u8f93\u51fa\u3002 Parameters: detector_2d ( Detector2DInterface ) \u2013 Detector2DInterface \u5916\u90e8\u6ce8\u5165\u7684 2D \u68c0\u6d4b\u5668\u6a21\u5757\uff0c\u5b9e\u73b0\u4ece\u56fe\u50cf\u5230 2D \u68c0\u6d4b\u6846\u4e0e\u5206\u6570\u7684\u63a8\u7406\u63a5\u53e3\u3002 detector_3d ( Detector3DInterface ) \u2013 Detector3DInterface \u5916\u90e8\u6ce8\u5165\u7684 3D \u68c0\u6d4b\u5668\u6a21\u5757\uff0c\u5b9e\u73b0\u4ece\u70b9\u4e91\u5230 3D \u68c0\u6d4b\u6846\u4e0e\u5206\u6570\u7684\u63a8\u7406\u63a5\u53e3\u3002 iou2d_thres ( float , default: 0.0 ) \u2013 float 2D IoU \u7684\u914d\u5bf9\u9608\u503c\uff0cIoU \u5927\u4e8e\u8be5\u503c\u7684 2D\u20133D \u7ec4\u5408\u4f1a\u88ab\u89c6\u4e3a\u6709\u6548\u5019\u9009\u5bf9\u53c2\u4e0e\u878d\u5408\u3002 iou3d_thres ( float , default: 0.5 ) \u2013 float 3D IoU \u7684 NMS \u9608\u503c\uff0cIoU \u5927\u4e8e\u8be5\u503c\u7684 3D \u68c0\u6d4b\u6846\u4f1a\u88ab\u8ba4\u4e3a\u91cd\u53e0\u8fc7\u9ad8\uff0c\u5728\u540e\u5904\u7406\u4e2d\u88ab\u6291\u5236\u3002 Returns: \u2013 forward(image, pointcloud, calib) -> (keep_indices, fused_scores) keep_indices: (M,) \u7ecf\u8fc7 3D NMS \u540e\u4fdd\u7559\u4e0b\u6765\u7684 3D \u68c0\u6d4b\u6846\u7d22\u5f15\uff0c\u5bf9\u5e94\u539f\u59cb 3D \u68c0\u6d4b\u5668\u8f93\u51fa\u4e2d\u7684\u4f4d\u7f6e\u3002 fused_scores: (N,) \u6bcf\u4e2a 3D \u68c0\u6d4b\u6846\u7684\u878d\u5408\u7f6e\u4fe1\u5ea6\u5206\u6570\uff0c\u7ed3\u5408\u4e86 2D \u4e0e 3D \u68c0\u6d4b\u4fe1\u606f\uff0c\u7528\u4e8e\u6392\u5e8f\u4e0e\u540e\u5904\u7406\u3002 Source code in CLOCs_LQS_framework.py 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 class CLOCs_LQS_Pipeline ( nn . Module ): \"\"\" CLOCs_LQS \u878d\u5408\u4e3b\u6846\u67b6\uff0c\u5c06 2D \u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u901a\u8fc7\u5019\u9009\u5339\u914d\u548c MLP \u878d\u5408\uff0c\u5f97\u5230\u6700\u7ec8\u7684 3D \u68c0\u6d4b\u8f93\u51fa\u3002 Args: detector_2d: Detector2DInterface \u5916\u90e8\u6ce8\u5165\u7684 2D \u68c0\u6d4b\u5668\u6a21\u5757\uff0c\u5b9e\u73b0\u4ece\u56fe\u50cf\u5230 2D \u68c0\u6d4b\u6846\u4e0e\u5206\u6570\u7684\u63a8\u7406\u63a5\u53e3\u3002 detector_3d: Detector3DInterface \u5916\u90e8\u6ce8\u5165\u7684 3D \u68c0\u6d4b\u5668\u6a21\u5757\uff0c\u5b9e\u73b0\u4ece\u70b9\u4e91\u5230 3D \u68c0\u6d4b\u6846\u4e0e\u5206\u6570\u7684\u63a8\u7406\u63a5\u53e3\u3002 iou2d_thres: float 2D IoU \u7684\u914d\u5bf9\u9608\u503c\uff0cIoU \u5927\u4e8e\u8be5\u503c\u7684 2D\u20133D \u7ec4\u5408\u4f1a\u88ab\u89c6\u4e3a\u6709\u6548\u5019\u9009\u5bf9\u53c2\u4e0e\u878d\u5408\u3002 iou3d_thres: float 3D IoU \u7684 NMS \u9608\u503c\uff0cIoU \u5927\u4e8e\u8be5\u503c\u7684 3D \u68c0\u6d4b\u6846\u4f1a\u88ab\u8ba4\u4e3a\u91cd\u53e0\u8fc7\u9ad8\uff0c\u5728\u540e\u5904\u7406\u4e2d\u88ab\u6291\u5236\u3002 Returns: forward(image, pointcloud, calib) -> (keep_indices, fused_scores) keep_indices: (M,) \u7ecf\u8fc7 3D NMS \u540e\u4fdd\u7559\u4e0b\u6765\u7684 3D \u68c0\u6d4b\u6846\u7d22\u5f15\uff0c\u5bf9\u5e94\u539f\u59cb 3D \u68c0\u6d4b\u5668\u8f93\u51fa\u4e2d\u7684\u4f4d\u7f6e\u3002 fused_scores: (N,) \u6bcf\u4e2a 3D \u68c0\u6d4b\u6846\u7684\u878d\u5408\u7f6e\u4fe1\u5ea6\u5206\u6570\uff0c\u7ed3\u5408\u4e86 2D \u4e0e 3D \u68c0\u6d4b\u4fe1\u606f\uff0c\u7528\u4e8e\u6392\u5e8f\u4e0e\u540e\u5904\u7406\u3002 \"\"\" def __init__ ( self , detector_2d : Detector2DInterface , detector_3d : Detector3DInterface , iou2d_thres : float = 0.0 , iou3d_thres : float = 0.5 ): super () . __init__ () self . det2d = detector_2d self . det3d = detector_3d self . mlp = FusionMLP () self . iou2d_thres = iou2d_thres self . iou3d_thres = iou3d_thres def forward ( self , image , pointcloud , calib ): \"\"\" \u6267\u884c\u5b8c\u6574\u7684 CLOCs_LQS \u878d\u5408\u6d41\u7a0b\uff0c\u5c06 2D \u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u878d\u5408\u4e3a\u6700\u7ec8 3D \u68c0\u6d4b\u6846\u8f93\u51fa\u3002 Args: image: \u8f93\u5165\u56fe\u50cf\u6570\u636e\uff0c\u7531 2D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 pointcloud: \u8f93\u5165\u70b9\u4e91\u6570\u636e\uff0c\u7531 3D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 calib: dict \u6807\u5b9a\u53c2\u6570\u5b57\u5178\uff0c\u5e94\u81f3\u5c11\u5305\u542b\u4ee5\u4e0b\u952e\u503c\uff1a - R0: (3,3) \u76f8\u673a\u5750\u6807\u7cfb\u77eb\u6b63\u77e9\u9635\uff0c\u7528\u4e8e\u5bf9\u9f50\u76f8\u673a\u5916\u53c2\u3002 - Tr_velo2cam: (3,4) LiDAR \u2192 Camera \u7684\u5750\u6807\u53d8\u6362\u77e9\u9635\u3002 - P2: (3,4) Camera \u2192 Image \u7684\u6295\u5f71\u77e9\u9635\uff0c\u7528\u4e8e\u5c06 3D \u6846\u6295\u5f71\u81f3\u56fe\u50cf\u5e73\u9762\u3002 Returns: keep_indices: (M,) NMS \u540e\u4fdd\u7559\u4e0b\u6765\u7684 3D \u68c0\u6d4b\u6846\u5728\u539f 3D \u68c0\u6d4b\u5668\u8f93\u51fa\u4e2d\u7684\u7d22\u5f15\u3002 fused_scores: (N,) \u5bf9\u6bcf\u4e2a 3D \u68c0\u6d4b\u6846\u7684\u6700\u7ec8\u878d\u5408\u7f6e\u4fe1\u5ea6\u5206\u6570\uff08\u878d\u5408 2D+3D \u4fe1\u606f\uff09\u3002 \"\"\" boxes_2d , scores_2d = self . det2d ( image ) boxes_3d , scores_3d = self . det3d ( pointcloud ) K = boxes_2d . shape [ 0 ] N = boxes_3d . shape [ 0 ] proj_2d = torch . ops . clocs . project_3d_to_image ( boxes_3d , calib [ \"R0\" ], calib [ \"Tr_velo2cam\" ], calib [ \"P2\" ] ) # (N,4) iou2d_mat = torch . ops . clocs . compute_iou2d ( boxes_2d , proj_2d ) # (K,N) pair_idx = torch . ops . clocs . pair_selector ( iou2d_mat , self . iou2d_thres ) # (p,2) if pair_idx . shape [ 0 ] == 0 : fused_scores = scores_3d . clone () keep = torch . ops . clocs . fused_nms ( boxes_3d , fused_scores , self . iou3d_thres ) return keep , fused_scores pair_feats = torch . ops . clocs . pair_feature_encoder ( pair_idx , iou2d_mat , scores_2d , scores_3d , boxes_3d ) # (4,1,p) pair_feats = pair_feats . unsqueeze ( 0 ) # (1,4,1,p) pair_feats = pair_feats . float () pair_scores = self . mlp ( pair_feats ) # (1,1,1,p) pair_scores = pair_scores . squeeze ( 0 ) # (1,1,p) # \u8c03\u7528\u6ce8\u518c\u7b97\u5b50 score_matrix = torch . ops . clocs . scatter_to_matrix ( pair_scores , pair_idx , K , N ) # (1,K,N) fused_scores = torch . ops . clocs . score_aggregator ( score_matrix ) # (N,) keep = torch . ops . clocs . fused_nms ( boxes_3d , fused_scores , self . iou3d_thres ) return keep , fused_scores forward ( image , pointcloud , calib ) \u00b6 \u6267\u884c\u5b8c\u6574\u7684 CLOCs_LQS \u878d\u5408\u6d41\u7a0b\uff0c\u5c06 2D \u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u878d\u5408\u4e3a\u6700\u7ec8 3D \u68c0\u6d4b\u6846\u8f93\u51fa\u3002 Parameters: image \u2013 \u8f93\u5165\u56fe\u50cf\u6570\u636e\uff0c\u7531 2D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 pointcloud \u2013 \u8f93\u5165\u70b9\u4e91\u6570\u636e\uff0c\u7531 3D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 calib \u2013 dict \u6807\u5b9a\u53c2\u6570\u5b57\u5178\uff0c\u5e94\u81f3\u5c11\u5305\u542b\u4ee5\u4e0b\u952e\u503c\uff1a - R0: (3,3) \u76f8\u673a\u5750\u6807\u7cfb\u77eb\u6b63\u77e9\u9635\uff0c\u7528\u4e8e\u5bf9\u9f50\u76f8\u673a\u5916\u53c2\u3002 - Tr_velo2cam: (3,4) LiDAR \u2192 Camera \u7684\u5750\u6807\u53d8\u6362\u77e9\u9635\u3002 - P2: (3,4) Camera \u2192 Image \u7684\u6295\u5f71\u77e9\u9635\uff0c\u7528\u4e8e\u5c06 3D \u6846\u6295\u5f71\u81f3\u56fe\u50cf\u5e73\u9762\u3002 Returns: keep_indices \u2013 (M,) NMS \u540e\u4fdd\u7559\u4e0b\u6765\u7684 3D \u68c0\u6d4b\u6846\u5728\u539f 3D \u68c0\u6d4b\u5668\u8f93\u51fa\u4e2d\u7684\u7d22\u5f15\u3002 fused_scores \u2013 (N,) \u5bf9\u6bcf\u4e2a 3D \u68c0\u6d4b\u6846\u7684\u6700\u7ec8\u878d\u5408\u7f6e\u4fe1\u5ea6\u5206\u6570\uff08\u878d\u5408 2D+3D \u4fe1\u606f\uff09\u3002 Source code in CLOCs_LQS_framework.py 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 def forward ( self , image , pointcloud , calib ): \"\"\" \u6267\u884c\u5b8c\u6574\u7684 CLOCs_LQS \u878d\u5408\u6d41\u7a0b\uff0c\u5c06 2D \u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u878d\u5408\u4e3a\u6700\u7ec8 3D \u68c0\u6d4b\u6846\u8f93\u51fa\u3002 Args: image: \u8f93\u5165\u56fe\u50cf\u6570\u636e\uff0c\u7531 2D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 pointcloud: \u8f93\u5165\u70b9\u4e91\u6570\u636e\uff0c\u7531 3D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 calib: dict \u6807\u5b9a\u53c2\u6570\u5b57\u5178\uff0c\u5e94\u81f3\u5c11\u5305\u542b\u4ee5\u4e0b\u952e\u503c\uff1a - R0: (3,3) \u76f8\u673a\u5750\u6807\u7cfb\u77eb\u6b63\u77e9\u9635\uff0c\u7528\u4e8e\u5bf9\u9f50\u76f8\u673a\u5916\u53c2\u3002 - Tr_velo2cam: (3,4) LiDAR \u2192 Camera \u7684\u5750\u6807\u53d8\u6362\u77e9\u9635\u3002 - P2: (3,4) Camera \u2192 Image \u7684\u6295\u5f71\u77e9\u9635\uff0c\u7528\u4e8e\u5c06 3D \u6846\u6295\u5f71\u81f3\u56fe\u50cf\u5e73\u9762\u3002 Returns: keep_indices: (M,) NMS \u540e\u4fdd\u7559\u4e0b\u6765\u7684 3D \u68c0\u6d4b\u6846\u5728\u539f 3D \u68c0\u6d4b\u5668\u8f93\u51fa\u4e2d\u7684\u7d22\u5f15\u3002 fused_scores: (N,) \u5bf9\u6bcf\u4e2a 3D \u68c0\u6d4b\u6846\u7684\u6700\u7ec8\u878d\u5408\u7f6e\u4fe1\u5ea6\u5206\u6570\uff08\u878d\u5408 2D+3D \u4fe1\u606f\uff09\u3002 \"\"\" boxes_2d , scores_2d = self . det2d ( image ) boxes_3d , scores_3d = self . det3d ( pointcloud ) K = boxes_2d . shape [ 0 ] N = boxes_3d . shape [ 0 ] proj_2d = torch . ops . clocs . project_3d_to_image ( boxes_3d , calib [ \"R0\" ], calib [ \"Tr_velo2cam\" ], calib [ \"P2\" ] ) # (N,4) iou2d_mat = torch . ops . clocs . compute_iou2d ( boxes_2d , proj_2d ) # (K,N) pair_idx = torch . ops . clocs . pair_selector ( iou2d_mat , self . iou2d_thres ) # (p,2) if pair_idx . shape [ 0 ] == 0 : fused_scores = scores_3d . clone () keep = torch . ops . clocs . fused_nms ( boxes_3d , fused_scores , self . iou3d_thres ) return keep , fused_scores pair_feats = torch . ops . clocs . pair_feature_encoder ( pair_idx , iou2d_mat , scores_2d , scores_3d , boxes_3d ) # (4,1,p) pair_feats = pair_feats . unsqueeze ( 0 ) # (1,4,1,p) pair_feats = pair_feats . float () pair_scores = self . mlp ( pair_feats ) # (1,1,1,p) pair_scores = pair_scores . squeeze ( 0 ) # (1,1,p) # \u8c03\u7528\u6ce8\u518c\u7b97\u5b50 score_matrix = torch . ops . clocs . scatter_to_matrix ( pair_scores , pair_idx , K , N ) # (1,K,N) fused_scores = torch . ops . clocs . score_aggregator ( score_matrix ) # (N,) keep = torch . ops . clocs . fused_nms ( boxes_3d , fused_scores , self . iou3d_thres ) return keep , fused_scores","title":"CLOCs_LQS \u878d\u5408\u6846\u67b6"},{"location":"CLOCs_LQS_framework/#clocs_lqs-framework","text":"CLOCs_LQS \u4e3b\u6846\u67b6\u5c06\u6240\u6709 Stage \u4e32\u8054\u8d77\u6765\uff0c\u5f62\u6210\u5b8c\u6574\u7684 2D\u20133D \u878d\u5408\u68c0\u6d4b\u6d41\u7a0b\u3002 \u4e3b\u878d\u5408\u6846\u67b6\uff0c\u5c06 2D/3D \u68c0\u6d4b\u5668\u3001\u5404 Stage \u7b97\u5b50\u4e32\u8054\u5f62\u6210\u5b8c\u6574\u878d\u5408\u6d41\u7a0b\u3002","title":"CLOCs_LQS Framework\uff08\u878d\u5408\u4e3b\u6846\u67b6\uff09"},{"location":"CLOCs_LQS_framework/#api","text":"","title":"API \u6587\u6863"},{"location":"CLOCs_LQS_framework/#clocs_lqs_pipeline","text":"Bases: Module CLOCs_LQS \u878d\u5408\u4e3b\u6846\u67b6\uff0c\u5c06 2D \u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u901a\u8fc7\u5019\u9009\u5339\u914d\u548c MLP \u878d\u5408\uff0c\u5f97\u5230\u6700\u7ec8\u7684 3D \u68c0\u6d4b\u8f93\u51fa\u3002 Parameters: detector_2d ( Detector2DInterface ) \u2013 Detector2DInterface \u5916\u90e8\u6ce8\u5165\u7684 2D \u68c0\u6d4b\u5668\u6a21\u5757\uff0c\u5b9e\u73b0\u4ece\u56fe\u50cf\u5230 2D \u68c0\u6d4b\u6846\u4e0e\u5206\u6570\u7684\u63a8\u7406\u63a5\u53e3\u3002 detector_3d ( Detector3DInterface ) \u2013 Detector3DInterface \u5916\u90e8\u6ce8\u5165\u7684 3D \u68c0\u6d4b\u5668\u6a21\u5757\uff0c\u5b9e\u73b0\u4ece\u70b9\u4e91\u5230 3D \u68c0\u6d4b\u6846\u4e0e\u5206\u6570\u7684\u63a8\u7406\u63a5\u53e3\u3002 iou2d_thres ( float , default: 0.0 ) \u2013 float 2D IoU \u7684\u914d\u5bf9\u9608\u503c\uff0cIoU \u5927\u4e8e\u8be5\u503c\u7684 2D\u20133D \u7ec4\u5408\u4f1a\u88ab\u89c6\u4e3a\u6709\u6548\u5019\u9009\u5bf9\u53c2\u4e0e\u878d\u5408\u3002 iou3d_thres ( float , default: 0.5 ) \u2013 float 3D IoU \u7684 NMS \u9608\u503c\uff0cIoU \u5927\u4e8e\u8be5\u503c\u7684 3D \u68c0\u6d4b\u6846\u4f1a\u88ab\u8ba4\u4e3a\u91cd\u53e0\u8fc7\u9ad8\uff0c\u5728\u540e\u5904\u7406\u4e2d\u88ab\u6291\u5236\u3002 Returns: \u2013 forward(image, pointcloud, calib) -> (keep_indices, fused_scores) keep_indices: (M,) \u7ecf\u8fc7 3D NMS \u540e\u4fdd\u7559\u4e0b\u6765\u7684 3D \u68c0\u6d4b\u6846\u7d22\u5f15\uff0c\u5bf9\u5e94\u539f\u59cb 3D \u68c0\u6d4b\u5668\u8f93\u51fa\u4e2d\u7684\u4f4d\u7f6e\u3002 fused_scores: (N,) \u6bcf\u4e2a 3D \u68c0\u6d4b\u6846\u7684\u878d\u5408\u7f6e\u4fe1\u5ea6\u5206\u6570\uff0c\u7ed3\u5408\u4e86 2D \u4e0e 3D \u68c0\u6d4b\u4fe1\u606f\uff0c\u7528\u4e8e\u6392\u5e8f\u4e0e\u540e\u5904\u7406\u3002 Source code in CLOCs_LQS_framework.py 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 class CLOCs_LQS_Pipeline ( nn . Module ): \"\"\" CLOCs_LQS \u878d\u5408\u4e3b\u6846\u67b6\uff0c\u5c06 2D \u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u901a\u8fc7\u5019\u9009\u5339\u914d\u548c MLP \u878d\u5408\uff0c\u5f97\u5230\u6700\u7ec8\u7684 3D \u68c0\u6d4b\u8f93\u51fa\u3002 Args: detector_2d: Detector2DInterface \u5916\u90e8\u6ce8\u5165\u7684 2D \u68c0\u6d4b\u5668\u6a21\u5757\uff0c\u5b9e\u73b0\u4ece\u56fe\u50cf\u5230 2D \u68c0\u6d4b\u6846\u4e0e\u5206\u6570\u7684\u63a8\u7406\u63a5\u53e3\u3002 detector_3d: Detector3DInterface \u5916\u90e8\u6ce8\u5165\u7684 3D \u68c0\u6d4b\u5668\u6a21\u5757\uff0c\u5b9e\u73b0\u4ece\u70b9\u4e91\u5230 3D \u68c0\u6d4b\u6846\u4e0e\u5206\u6570\u7684\u63a8\u7406\u63a5\u53e3\u3002 iou2d_thres: float 2D IoU \u7684\u914d\u5bf9\u9608\u503c\uff0cIoU \u5927\u4e8e\u8be5\u503c\u7684 2D\u20133D \u7ec4\u5408\u4f1a\u88ab\u89c6\u4e3a\u6709\u6548\u5019\u9009\u5bf9\u53c2\u4e0e\u878d\u5408\u3002 iou3d_thres: float 3D IoU \u7684 NMS \u9608\u503c\uff0cIoU \u5927\u4e8e\u8be5\u503c\u7684 3D \u68c0\u6d4b\u6846\u4f1a\u88ab\u8ba4\u4e3a\u91cd\u53e0\u8fc7\u9ad8\uff0c\u5728\u540e\u5904\u7406\u4e2d\u88ab\u6291\u5236\u3002 Returns: forward(image, pointcloud, calib) -> (keep_indices, fused_scores) keep_indices: (M,) \u7ecf\u8fc7 3D NMS \u540e\u4fdd\u7559\u4e0b\u6765\u7684 3D \u68c0\u6d4b\u6846\u7d22\u5f15\uff0c\u5bf9\u5e94\u539f\u59cb 3D \u68c0\u6d4b\u5668\u8f93\u51fa\u4e2d\u7684\u4f4d\u7f6e\u3002 fused_scores: (N,) \u6bcf\u4e2a 3D \u68c0\u6d4b\u6846\u7684\u878d\u5408\u7f6e\u4fe1\u5ea6\u5206\u6570\uff0c\u7ed3\u5408\u4e86 2D \u4e0e 3D \u68c0\u6d4b\u4fe1\u606f\uff0c\u7528\u4e8e\u6392\u5e8f\u4e0e\u540e\u5904\u7406\u3002 \"\"\" def __init__ ( self , detector_2d : Detector2DInterface , detector_3d : Detector3DInterface , iou2d_thres : float = 0.0 , iou3d_thres : float = 0.5 ): super () . __init__ () self . det2d = detector_2d self . det3d = detector_3d self . mlp = FusionMLP () self . iou2d_thres = iou2d_thres self . iou3d_thres = iou3d_thres def forward ( self , image , pointcloud , calib ): \"\"\" \u6267\u884c\u5b8c\u6574\u7684 CLOCs_LQS \u878d\u5408\u6d41\u7a0b\uff0c\u5c06 2D \u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u878d\u5408\u4e3a\u6700\u7ec8 3D \u68c0\u6d4b\u6846\u8f93\u51fa\u3002 Args: image: \u8f93\u5165\u56fe\u50cf\u6570\u636e\uff0c\u7531 2D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 pointcloud: \u8f93\u5165\u70b9\u4e91\u6570\u636e\uff0c\u7531 3D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 calib: dict \u6807\u5b9a\u53c2\u6570\u5b57\u5178\uff0c\u5e94\u81f3\u5c11\u5305\u542b\u4ee5\u4e0b\u952e\u503c\uff1a - R0: (3,3) \u76f8\u673a\u5750\u6807\u7cfb\u77eb\u6b63\u77e9\u9635\uff0c\u7528\u4e8e\u5bf9\u9f50\u76f8\u673a\u5916\u53c2\u3002 - Tr_velo2cam: (3,4) LiDAR \u2192 Camera \u7684\u5750\u6807\u53d8\u6362\u77e9\u9635\u3002 - P2: (3,4) Camera \u2192 Image \u7684\u6295\u5f71\u77e9\u9635\uff0c\u7528\u4e8e\u5c06 3D \u6846\u6295\u5f71\u81f3\u56fe\u50cf\u5e73\u9762\u3002 Returns: keep_indices: (M,) NMS \u540e\u4fdd\u7559\u4e0b\u6765\u7684 3D \u68c0\u6d4b\u6846\u5728\u539f 3D \u68c0\u6d4b\u5668\u8f93\u51fa\u4e2d\u7684\u7d22\u5f15\u3002 fused_scores: (N,) \u5bf9\u6bcf\u4e2a 3D \u68c0\u6d4b\u6846\u7684\u6700\u7ec8\u878d\u5408\u7f6e\u4fe1\u5ea6\u5206\u6570\uff08\u878d\u5408 2D+3D \u4fe1\u606f\uff09\u3002 \"\"\" boxes_2d , scores_2d = self . det2d ( image ) boxes_3d , scores_3d = self . det3d ( pointcloud ) K = boxes_2d . shape [ 0 ] N = boxes_3d . shape [ 0 ] proj_2d = torch . ops . clocs . project_3d_to_image ( boxes_3d , calib [ \"R0\" ], calib [ \"Tr_velo2cam\" ], calib [ \"P2\" ] ) # (N,4) iou2d_mat = torch . ops . clocs . compute_iou2d ( boxes_2d , proj_2d ) # (K,N) pair_idx = torch . ops . clocs . pair_selector ( iou2d_mat , self . iou2d_thres ) # (p,2) if pair_idx . shape [ 0 ] == 0 : fused_scores = scores_3d . clone () keep = torch . ops . clocs . fused_nms ( boxes_3d , fused_scores , self . iou3d_thres ) return keep , fused_scores pair_feats = torch . ops . clocs . pair_feature_encoder ( pair_idx , iou2d_mat , scores_2d , scores_3d , boxes_3d ) # (4,1,p) pair_feats = pair_feats . unsqueeze ( 0 ) # (1,4,1,p) pair_feats = pair_feats . float () pair_scores = self . mlp ( pair_feats ) # (1,1,1,p) pair_scores = pair_scores . squeeze ( 0 ) # (1,1,p) # \u8c03\u7528\u6ce8\u518c\u7b97\u5b50 score_matrix = torch . ops . clocs . scatter_to_matrix ( pair_scores , pair_idx , K , N ) # (1,K,N) fused_scores = torch . ops . clocs . score_aggregator ( score_matrix ) # (N,) keep = torch . ops . clocs . fused_nms ( boxes_3d , fused_scores , self . iou3d_thres ) return keep , fused_scores","title":"CLOCs_LQS_Pipeline"},{"location":"CLOCs_LQS_framework/#CLOCs_LQS_framework.CLOCs_LQS_Pipeline.forward","text":"\u6267\u884c\u5b8c\u6574\u7684 CLOCs_LQS \u878d\u5408\u6d41\u7a0b\uff0c\u5c06 2D \u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u878d\u5408\u4e3a\u6700\u7ec8 3D \u68c0\u6d4b\u6846\u8f93\u51fa\u3002 Parameters: image \u2013 \u8f93\u5165\u56fe\u50cf\u6570\u636e\uff0c\u7531 2D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 pointcloud \u2013 \u8f93\u5165\u70b9\u4e91\u6570\u636e\uff0c\u7531 3D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 calib \u2013 dict \u6807\u5b9a\u53c2\u6570\u5b57\u5178\uff0c\u5e94\u81f3\u5c11\u5305\u542b\u4ee5\u4e0b\u952e\u503c\uff1a - R0: (3,3) \u76f8\u673a\u5750\u6807\u7cfb\u77eb\u6b63\u77e9\u9635\uff0c\u7528\u4e8e\u5bf9\u9f50\u76f8\u673a\u5916\u53c2\u3002 - Tr_velo2cam: (3,4) LiDAR \u2192 Camera \u7684\u5750\u6807\u53d8\u6362\u77e9\u9635\u3002 - P2: (3,4) Camera \u2192 Image \u7684\u6295\u5f71\u77e9\u9635\uff0c\u7528\u4e8e\u5c06 3D \u6846\u6295\u5f71\u81f3\u56fe\u50cf\u5e73\u9762\u3002 Returns: keep_indices \u2013 (M,) NMS \u540e\u4fdd\u7559\u4e0b\u6765\u7684 3D \u68c0\u6d4b\u6846\u5728\u539f 3D \u68c0\u6d4b\u5668\u8f93\u51fa\u4e2d\u7684\u7d22\u5f15\u3002 fused_scores \u2013 (N,) \u5bf9\u6bcf\u4e2a 3D \u68c0\u6d4b\u6846\u7684\u6700\u7ec8\u878d\u5408\u7f6e\u4fe1\u5ea6\u5206\u6570\uff08\u878d\u5408 2D+3D \u4fe1\u606f\uff09\u3002 Source code in CLOCs_LQS_framework.py 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 def forward ( self , image , pointcloud , calib ): \"\"\" \u6267\u884c\u5b8c\u6574\u7684 CLOCs_LQS \u878d\u5408\u6d41\u7a0b\uff0c\u5c06 2D \u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u878d\u5408\u4e3a\u6700\u7ec8 3D \u68c0\u6d4b\u6846\u8f93\u51fa\u3002 Args: image: \u8f93\u5165\u56fe\u50cf\u6570\u636e\uff0c\u7531 2D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 pointcloud: \u8f93\u5165\u70b9\u4e91\u6570\u636e\uff0c\u7531 3D \u68c0\u6d4b\u5668\u81ea\u884c\u51b3\u5b9a\u683c\u5f0f\u3002 calib: dict \u6807\u5b9a\u53c2\u6570\u5b57\u5178\uff0c\u5e94\u81f3\u5c11\u5305\u542b\u4ee5\u4e0b\u952e\u503c\uff1a - R0: (3,3) \u76f8\u673a\u5750\u6807\u7cfb\u77eb\u6b63\u77e9\u9635\uff0c\u7528\u4e8e\u5bf9\u9f50\u76f8\u673a\u5916\u53c2\u3002 - Tr_velo2cam: (3,4) LiDAR \u2192 Camera \u7684\u5750\u6807\u53d8\u6362\u77e9\u9635\u3002 - P2: (3,4) Camera \u2192 Image \u7684\u6295\u5f71\u77e9\u9635\uff0c\u7528\u4e8e\u5c06 3D \u6846\u6295\u5f71\u81f3\u56fe\u50cf\u5e73\u9762\u3002 Returns: keep_indices: (M,) NMS \u540e\u4fdd\u7559\u4e0b\u6765\u7684 3D \u68c0\u6d4b\u6846\u5728\u539f 3D \u68c0\u6d4b\u5668\u8f93\u51fa\u4e2d\u7684\u7d22\u5f15\u3002 fused_scores: (N,) \u5bf9\u6bcf\u4e2a 3D \u68c0\u6d4b\u6846\u7684\u6700\u7ec8\u878d\u5408\u7f6e\u4fe1\u5ea6\u5206\u6570\uff08\u878d\u5408 2D+3D \u4fe1\u606f\uff09\u3002 \"\"\" boxes_2d , scores_2d = self . det2d ( image ) boxes_3d , scores_3d = self . det3d ( pointcloud ) K = boxes_2d . shape [ 0 ] N = boxes_3d . shape [ 0 ] proj_2d = torch . ops . clocs . project_3d_to_image ( boxes_3d , calib [ \"R0\" ], calib [ \"Tr_velo2cam\" ], calib [ \"P2\" ] ) # (N,4) iou2d_mat = torch . ops . clocs . compute_iou2d ( boxes_2d , proj_2d ) # (K,N) pair_idx = torch . ops . clocs . pair_selector ( iou2d_mat , self . iou2d_thres ) # (p,2) if pair_idx . shape [ 0 ] == 0 : fused_scores = scores_3d . clone () keep = torch . ops . clocs . fused_nms ( boxes_3d , fused_scores , self . iou3d_thres ) return keep , fused_scores pair_feats = torch . ops . clocs . pair_feature_encoder ( pair_idx , iou2d_mat , scores_2d , scores_3d , boxes_3d ) # (4,1,p) pair_feats = pair_feats . unsqueeze ( 0 ) # (1,4,1,p) pair_feats = pair_feats . float () pair_scores = self . mlp ( pair_feats ) # (1,1,1,p) pair_scores = pair_scores . squeeze ( 0 ) # (1,1,p) # \u8c03\u7528\u6ce8\u518c\u7b97\u5b50 score_matrix = torch . ops . clocs . scatter_to_matrix ( pair_scores , pair_idx , K , N ) # (1,K,N) fused_scores = torch . ops . clocs . score_aggregator ( score_matrix ) # (N,) keep = torch . ops . clocs . fused_nms ( boxes_3d , fused_scores , self . iou3d_thres ) return keep , fused_scores","title":"forward"},{"location":"Stage1_CandidateMatching/","text":"Stage 1 \u2014 Candidate Matching\uff08\u5019\u9009\u5339\u914d\uff09 \u00b6 \u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u5728 2D \u68c0\u6d4b\u7ed3\u679c\u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u4e4b\u95f4\u5efa\u7acb\u5bf9\u5e94\u5173\u7cfb \uff0c\u4e3a\u540e\u7eed\u878d\u5408\u627e\u5230\u53ef\u5339\u914d\u7684 (2D_i, 3D_j) \u5bf9\u8c61\u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e09\u4e2a\u7b97\u5b50\uff1a project_3d_to_image \u5c06 3D \u6846\u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u3002 compute_iou2d \u8ba1\u7b97\u6295\u5f71\u6846\u4e0e 2D \u68c0\u6d4b\u6846\u7684 IoU\u2082D\u3002 pair_selector \u6839\u636e IoU \u9608\u503c\u7b5b\u9009\u6709\u6548 (2D_i, 3D_j) pair\u3002 API \u6587\u6863 \u00b6 project_3d_to_image \u00b6 project_3d_to_image ( boxes_3d_lidar , R0 , Tr_velo2cam , P2 ) \u00b6 \u5c06 LiDAR \u5750\u6807\u7cfb\u4e2d\u7684 3D \u68c0\u6d4b\u6846\u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\uff0c\u751f\u6210\u5bf9\u5e94\u7684 2D \u8fb9\u754c\u6846\u3002 Parameters: boxes_3d_lidar ( Tensor ) \u2013 (N, 7) \u6bcf\u4e2a 3D \u6846\u7684\u53c2\u6570 [x, y, z, w, l, h, yaw]\uff0c\u8868\u793a\u5728 LiDAR \u5750\u6807\u7cfb\u4e0b\u7684\u4f4d\u7f6e\u4e0e\u5c3a\u5bf8\u3002 R0 ( Tensor ) \u2013 (3,3) \u76f8\u673a\u77eb\u6b63\u77e9\u9635\uff0c\u7528\u4e8e\u5bf9\u9f50\u5750\u6807\u7cfb\u3002 Tr_velo2cam ( Tensor ) \u2013 (3,4) LiDAR \u2192 Camera \u7684\u5750\u6807\u53d8\u6362\u77e9\u9635\u3002 P2 ( Tensor ) \u2013 (3,4) Camera \u2192 Image \u7684\u6295\u5f71\u77e9\u9635\uff0c\u7528\u4e8e\u751f\u6210\u56fe\u50cf\u5750\u6807\u3002 Returns: proj_boxes_2d ( Tensor ) \u2013 (N, 4) \u6bcf\u4e2a 3D \u6846\u5bf9\u5e94\u7684\u6295\u5f71 2D \u6846 [x1, y1, x2, y2]\uff08\u56fe\u50cf\u5750\u6807\u7cfb\uff09\u3002 Source code in Stage1_CandidateMatching\\operator\\project_3d_to_image.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 @torch . library . custom_op ( \"clocs::project_3d_to_image\" , mutates_args = []) def project_3d_to_image ( boxes_3d_lidar : torch . Tensor , R0 : torch . Tensor , Tr_velo2cam : torch . Tensor , P2 : torch . Tensor ) -> torch . Tensor : \"\"\" \u5c06 LiDAR \u5750\u6807\u7cfb\u4e2d\u7684 3D \u68c0\u6d4b\u6846\u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\uff0c\u751f\u6210\u5bf9\u5e94\u7684 2D \u8fb9\u754c\u6846\u3002 Args: boxes_3d_lidar: (N, 7) \u6bcf\u4e2a 3D \u6846\u7684\u53c2\u6570 [x, y, z, w, l, h, yaw]\uff0c\u8868\u793a\u5728 LiDAR \u5750\u6807\u7cfb\u4e0b\u7684\u4f4d\u7f6e\u4e0e\u5c3a\u5bf8\u3002 R0: (3,3) \u76f8\u673a\u77eb\u6b63\u77e9\u9635\uff0c\u7528\u4e8e\u5bf9\u9f50\u5750\u6807\u7cfb\u3002 Tr_velo2cam: (3,4) LiDAR \u2192 Camera \u7684\u5750\u6807\u53d8\u6362\u77e9\u9635\u3002 P2: (3,4) Camera \u2192 Image \u7684\u6295\u5f71\u77e9\u9635\uff0c\u7528\u4e8e\u751f\u6210\u56fe\u50cf\u5750\u6807\u3002 Returns: proj_boxes_2d: (N, 4) \u6bcf\u4e2a 3D \u6846\u5bf9\u5e94\u7684\u6295\u5f71 2D \u6846 [x1, y1, x2, y2]\uff08\u56fe\u50cf\u5750\u6807\u7cfb\uff09\u3002 \"\"\" # \u8f6c numpy \u8ba1\u7b97 boxes = boxes_3d_lidar . detach () . cpu () . numpy () R0 = R0 . detach () . cpu () . numpy () V2C = Tr_velo2cam . detach () . cpu () . numpy () P2 = P2 . detach () . cpu () . numpy () xyz_lidar = boxes [:, 0 : 3 ] xyz_lidar_hom = np . concatenate ([ xyz_lidar , np . ones (( xyz_lidar . shape [ 0 ], 1 ))], axis = 1 ) xyz_cam = ( R0 @ ( V2C @ xyz_lidar_hom . T )) . T xyz_cam_hom = np . concatenate ([ xyz_cam , np . ones (( xyz_cam . shape [ 0 ], 1 ))], axis = 1 ) pts_2d = ( P2 @ xyz_cam_hom . T ) . T pts_2d [:, 0 ] /= pts_2d [:, 2 ] pts_2d [:, 1 ] /= pts_2d [:, 2 ] w = boxes [:, 3 ] h = boxes [:, 5 ] x1 = pts_2d [:, 0 ] - w y1 = pts_2d [:, 1 ] - h x2 = pts_2d [:, 0 ] + w y2 = pts_2d [:, 1 ] + h proj = np . stack ([ x1 , y1 , x2 , y2 ], axis = 1 ) return torch . from_numpy ( proj ) . to ( boxes_3d_lidar . device ) compute_iou2d \u00b6 compute_iou2d ( boxes_2d , proj_boxes_2d ) \u00b6 \u8ba1\u7b97 2D \u68c0\u6d4b\u6846\u4e0e 3D \u6295\u5f71\u6846\u4e4b\u95f4\u7684 IoU\uff0c\u5e76\u8fd4\u56de\u5f62\u72b6\u4e3a (K, N) \u7684 IoU \u77e9\u9635\u3002 Parameters: boxes_2d ( Tensor ) \u2013 (K, 4) 2D \u68c0\u6d4b\u5668\u8f93\u51fa\u7684\u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 proj_boxes_2d ( Tensor ) \u2013 (N, 4) 3D \u68c0\u6d4b\u6846\u6295\u5f71\u5230\u56fe\u50cf\u540e\u7684 2D \u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 Returns: iou_matrix ( Tensor ) \u2013 (K, N) IoU \u77e9\u9635\uff0c\u7b2c (i, j) \u4f4d\u7f6e\u8868\u793a\u7b2c i \u4e2a 2D \u6846\u4e0e\u7b2c j \u4e2a\u6295\u5f71 3D \u6846\u4e4b\u95f4\u7684 IoU\u3002 Source code in Stage1_CandidateMatching\\operator\\compute_iou2d.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 @torch . library . custom_op ( \"clocs::compute_iou2d\" , mutates_args = []) def compute_iou2d ( boxes_2d : torch . Tensor , proj_boxes_2d : torch . Tensor ) -> torch . Tensor : \"\"\" \u8ba1\u7b97 2D \u68c0\u6d4b\u6846\u4e0e 3D \u6295\u5f71\u6846\u4e4b\u95f4\u7684 IoU\uff0c\u5e76\u8fd4\u56de\u5f62\u72b6\u4e3a (K, N) \u7684 IoU \u77e9\u9635\u3002 Args: boxes_2d: (K, 4) 2D \u68c0\u6d4b\u5668\u8f93\u51fa\u7684\u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 proj_boxes_2d: (N, 4) 3D \u68c0\u6d4b\u6846\u6295\u5f71\u5230\u56fe\u50cf\u540e\u7684 2D \u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 Returns: iou_matrix: (K, N) IoU \u77e9\u9635\uff0c\u7b2c (i, j) \u4f4d\u7f6e\u8868\u793a\u7b2c i \u4e2a 2D \u6846\u4e0e\u7b2c j \u4e2a\u6295\u5f71 3D \u6846\u4e4b\u95f4\u7684 IoU\u3002 \"\"\" a = boxes_2d b = proj_boxes_2d K = a . shape [ 0 ] N = b . shape [ 0 ] a = a . unsqueeze ( 1 ) # [K,1,4] b = b . unsqueeze ( 0 ) # [1,N,4] x1 = torch . max ( a [:,:, 0 ], b [:,:, 0 ]) y1 = torch . max ( a [:,:, 1 ], b [:,:, 1 ]) x2 = torch . min ( a [:,:, 2 ], b [:,:, 2 ]) y2 = torch . min ( a [:,:, 3 ], b [:,:, 3 ]) inter_w = ( x2 - x1 ) . clamp ( min = 0 ) inter_h = ( y2 - y1 ) . clamp ( min = 0 ) inter = inter_w * inter_h area_a = ( a [:,:, 2 ] - a [:,:, 0 ]) * ( a [:,:, 3 ] - a [:,:, 1 ]) area_b = ( b [:,:, 2 ] - b [:,:, 0 ]) * ( b [:,:, 3 ] - b [:,:, 1 ]) union = area_a + area_b - inter iou = inter / torch . clamp ( union , min = 1e-6 ) return iou pair_selector \u00b6 pair_selector ( iou_matrix , iou_threshold = 0.0 ) \u00b6 \u6839\u636e 2D IoU \u7b5b\u9009\u6709\u6548\u7684 (2D_i, 3D_j) \u914d\u5bf9\uff0c\u5e76\u8fd4\u56de\u5176\u7d22\u5f15\u3002 Parameters: iou_matrix ( Tensor ) \u2013 (K, N) 2D IoU \u77e9\u9635\uff0c\u7b2c i \u884c\u5bf9\u5e94\u7b2c i \u4e2a 2D \u6846\uff0c\u7b2c j \u5217\u5bf9\u5e94\u7b2c j \u4e2a 3D \u6295\u5f71\u6846\u3002 iou_threshold ( float , default: 0.0 ) \u2013 float IoU \u9009\u62e9\u9608\u503c\uff0c\u53ea\u6709 IoU > \u9608\u503c \u7684 (i, j) \u624d\u88ab\u9009\u4e3a\u6709\u6548\u914d\u5bf9\u3002 Returns: pair_indices ( Tensor ) \u2013 (p, 2) \u6bcf\u884c\u8868\u793a\u4e00\u4e2a\u6709\u6548\u914d\u5bf9\uff0c\u683c\u5f0f\u4e3a (i_2d, j_3d)\uff0c\u5171 p \u4e2a\u914d\u5bf9\u3002 Source code in Stage1_CandidateMatching\\operator\\pair_selector.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 @torch . library . custom_op ( \"clocs::pair_selector\" , mutates_args = []) def pair_selector ( iou_matrix : torch . Tensor , iou_threshold : float = 0.0 ) -> torch . Tensor : \"\"\" \u6839\u636e 2D IoU \u7b5b\u9009\u6709\u6548\u7684 (2D_i, 3D_j) \u914d\u5bf9\uff0c\u5e76\u8fd4\u56de\u5176\u7d22\u5f15\u3002 Args: iou_matrix: (K, N) 2D IoU \u77e9\u9635\uff0c\u7b2c i \u884c\u5bf9\u5e94\u7b2c i \u4e2a 2D \u6846\uff0c\u7b2c j \u5217\u5bf9\u5e94\u7b2c j \u4e2a 3D \u6295\u5f71\u6846\u3002 iou_threshold: float IoU \u9009\u62e9\u9608\u503c\uff0c\u53ea\u6709 IoU > \u9608\u503c \u7684 (i, j) \u624d\u88ab\u9009\u4e3a\u6709\u6548\u914d\u5bf9\u3002 Returns: pair_indices: (p, 2) \u6bcf\u884c\u8868\u793a\u4e00\u4e2a\u6709\u6548\u914d\u5bf9\uff0c\u683c\u5f0f\u4e3a (i_2d, j_3d)\uff0c\u5171 p \u4e2a\u914d\u5bf9\u3002 \"\"\" K , N = iou_matrix . shape # \u627e\u51fa\u6240\u6709\u6ee1\u8db3 IoU > threshold \u7684\u4f4d\u7f6e valid = ( iou_matrix > iou_threshold ) # nonzero() \u5f97\u5230\u6240\u6709 (i,j) \u5750\u6807 idx = valid . nonzero ( as_tuple = False ) # [p, 2] return idx","title":"Stage1 \u5019\u9009\u5339\u914d (Candidate Matching)"},{"location":"Stage1_CandidateMatching/#stage-1-candidate-matching","text":"\u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u5728 2D \u68c0\u6d4b\u7ed3\u679c\u4e0e 3D \u68c0\u6d4b\u7ed3\u679c\u4e4b\u95f4\u5efa\u7acb\u5bf9\u5e94\u5173\u7cfb \uff0c\u4e3a\u540e\u7eed\u878d\u5408\u627e\u5230\u53ef\u5339\u914d\u7684 (2D_i, 3D_j) \u5bf9\u8c61\u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e09\u4e2a\u7b97\u5b50\uff1a project_3d_to_image \u5c06 3D \u6846\u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\u3002 compute_iou2d \u8ba1\u7b97\u6295\u5f71\u6846\u4e0e 2D \u68c0\u6d4b\u6846\u7684 IoU\u2082D\u3002 pair_selector \u6839\u636e IoU \u9608\u503c\u7b5b\u9009\u6709\u6548 (2D_i, 3D_j) pair\u3002","title":"Stage 1 \u2014 Candidate Matching\uff08\u5019\u9009\u5339\u914d\uff09"},{"location":"Stage1_CandidateMatching/#api","text":"","title":"API \u6587\u6863"},{"location":"Stage1_CandidateMatching/#project_3d_to_image","text":"","title":"project_3d_to_image"},{"location":"Stage1_CandidateMatching/#Stage1_CandidateMatching.operator.project_3d_to_image.project_3d_to_image","text":"\u5c06 LiDAR \u5750\u6807\u7cfb\u4e2d\u7684 3D \u68c0\u6d4b\u6846\u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\uff0c\u751f\u6210\u5bf9\u5e94\u7684 2D \u8fb9\u754c\u6846\u3002 Parameters: boxes_3d_lidar ( Tensor ) \u2013 (N, 7) \u6bcf\u4e2a 3D \u6846\u7684\u53c2\u6570 [x, y, z, w, l, h, yaw]\uff0c\u8868\u793a\u5728 LiDAR \u5750\u6807\u7cfb\u4e0b\u7684\u4f4d\u7f6e\u4e0e\u5c3a\u5bf8\u3002 R0 ( Tensor ) \u2013 (3,3) \u76f8\u673a\u77eb\u6b63\u77e9\u9635\uff0c\u7528\u4e8e\u5bf9\u9f50\u5750\u6807\u7cfb\u3002 Tr_velo2cam ( Tensor ) \u2013 (3,4) LiDAR \u2192 Camera \u7684\u5750\u6807\u53d8\u6362\u77e9\u9635\u3002 P2 ( Tensor ) \u2013 (3,4) Camera \u2192 Image \u7684\u6295\u5f71\u77e9\u9635\uff0c\u7528\u4e8e\u751f\u6210\u56fe\u50cf\u5750\u6807\u3002 Returns: proj_boxes_2d ( Tensor ) \u2013 (N, 4) \u6bcf\u4e2a 3D \u6846\u5bf9\u5e94\u7684\u6295\u5f71 2D \u6846 [x1, y1, x2, y2]\uff08\u56fe\u50cf\u5750\u6807\u7cfb\uff09\u3002 Source code in Stage1_CandidateMatching\\operator\\project_3d_to_image.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 @torch . library . custom_op ( \"clocs::project_3d_to_image\" , mutates_args = []) def project_3d_to_image ( boxes_3d_lidar : torch . Tensor , R0 : torch . Tensor , Tr_velo2cam : torch . Tensor , P2 : torch . Tensor ) -> torch . Tensor : \"\"\" \u5c06 LiDAR \u5750\u6807\u7cfb\u4e2d\u7684 3D \u68c0\u6d4b\u6846\u6295\u5f71\u5230\u56fe\u50cf\u5e73\u9762\uff0c\u751f\u6210\u5bf9\u5e94\u7684 2D \u8fb9\u754c\u6846\u3002 Args: boxes_3d_lidar: (N, 7) \u6bcf\u4e2a 3D \u6846\u7684\u53c2\u6570 [x, y, z, w, l, h, yaw]\uff0c\u8868\u793a\u5728 LiDAR \u5750\u6807\u7cfb\u4e0b\u7684\u4f4d\u7f6e\u4e0e\u5c3a\u5bf8\u3002 R0: (3,3) \u76f8\u673a\u77eb\u6b63\u77e9\u9635\uff0c\u7528\u4e8e\u5bf9\u9f50\u5750\u6807\u7cfb\u3002 Tr_velo2cam: (3,4) LiDAR \u2192 Camera \u7684\u5750\u6807\u53d8\u6362\u77e9\u9635\u3002 P2: (3,4) Camera \u2192 Image \u7684\u6295\u5f71\u77e9\u9635\uff0c\u7528\u4e8e\u751f\u6210\u56fe\u50cf\u5750\u6807\u3002 Returns: proj_boxes_2d: (N, 4) \u6bcf\u4e2a 3D \u6846\u5bf9\u5e94\u7684\u6295\u5f71 2D \u6846 [x1, y1, x2, y2]\uff08\u56fe\u50cf\u5750\u6807\u7cfb\uff09\u3002 \"\"\" # \u8f6c numpy \u8ba1\u7b97 boxes = boxes_3d_lidar . detach () . cpu () . numpy () R0 = R0 . detach () . cpu () . numpy () V2C = Tr_velo2cam . detach () . cpu () . numpy () P2 = P2 . detach () . cpu () . numpy () xyz_lidar = boxes [:, 0 : 3 ] xyz_lidar_hom = np . concatenate ([ xyz_lidar , np . ones (( xyz_lidar . shape [ 0 ], 1 ))], axis = 1 ) xyz_cam = ( R0 @ ( V2C @ xyz_lidar_hom . T )) . T xyz_cam_hom = np . concatenate ([ xyz_cam , np . ones (( xyz_cam . shape [ 0 ], 1 ))], axis = 1 ) pts_2d = ( P2 @ xyz_cam_hom . T ) . T pts_2d [:, 0 ] /= pts_2d [:, 2 ] pts_2d [:, 1 ] /= pts_2d [:, 2 ] w = boxes [:, 3 ] h = boxes [:, 5 ] x1 = pts_2d [:, 0 ] - w y1 = pts_2d [:, 1 ] - h x2 = pts_2d [:, 0 ] + w y2 = pts_2d [:, 1 ] + h proj = np . stack ([ x1 , y1 , x2 , y2 ], axis = 1 ) return torch . from_numpy ( proj ) . to ( boxes_3d_lidar . device )","title":"project_3d_to_image"},{"location":"Stage1_CandidateMatching/#compute_iou2d","text":"","title":"compute_iou2d"},{"location":"Stage1_CandidateMatching/#Stage1_CandidateMatching.operator.compute_iou2d.compute_iou2d","text":"\u8ba1\u7b97 2D \u68c0\u6d4b\u6846\u4e0e 3D \u6295\u5f71\u6846\u4e4b\u95f4\u7684 IoU\uff0c\u5e76\u8fd4\u56de\u5f62\u72b6\u4e3a (K, N) \u7684 IoU \u77e9\u9635\u3002 Parameters: boxes_2d ( Tensor ) \u2013 (K, 4) 2D \u68c0\u6d4b\u5668\u8f93\u51fa\u7684\u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 proj_boxes_2d ( Tensor ) \u2013 (N, 4) 3D \u68c0\u6d4b\u6846\u6295\u5f71\u5230\u56fe\u50cf\u540e\u7684 2D \u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 Returns: iou_matrix ( Tensor ) \u2013 (K, N) IoU \u77e9\u9635\uff0c\u7b2c (i, j) \u4f4d\u7f6e\u8868\u793a\u7b2c i \u4e2a 2D \u6846\u4e0e\u7b2c j \u4e2a\u6295\u5f71 3D \u6846\u4e4b\u95f4\u7684 IoU\u3002 Source code in Stage1_CandidateMatching\\operator\\compute_iou2d.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 @torch . library . custom_op ( \"clocs::compute_iou2d\" , mutates_args = []) def compute_iou2d ( boxes_2d : torch . Tensor , proj_boxes_2d : torch . Tensor ) -> torch . Tensor : \"\"\" \u8ba1\u7b97 2D \u68c0\u6d4b\u6846\u4e0e 3D \u6295\u5f71\u6846\u4e4b\u95f4\u7684 IoU\uff0c\u5e76\u8fd4\u56de\u5f62\u72b6\u4e3a (K, N) \u7684 IoU \u77e9\u9635\u3002 Args: boxes_2d: (K, 4) 2D \u68c0\u6d4b\u5668\u8f93\u51fa\u7684\u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 proj_boxes_2d: (N, 4) 3D \u68c0\u6d4b\u6846\u6295\u5f71\u5230\u56fe\u50cf\u540e\u7684 2D \u8fb9\u754c\u6846\uff0c\u683c\u5f0f [x1, y1, x2, y2]\u3002 Returns: iou_matrix: (K, N) IoU \u77e9\u9635\uff0c\u7b2c (i, j) \u4f4d\u7f6e\u8868\u793a\u7b2c i \u4e2a 2D \u6846\u4e0e\u7b2c j \u4e2a\u6295\u5f71 3D \u6846\u4e4b\u95f4\u7684 IoU\u3002 \"\"\" a = boxes_2d b = proj_boxes_2d K = a . shape [ 0 ] N = b . shape [ 0 ] a = a . unsqueeze ( 1 ) # [K,1,4] b = b . unsqueeze ( 0 ) # [1,N,4] x1 = torch . max ( a [:,:, 0 ], b [:,:, 0 ]) y1 = torch . max ( a [:,:, 1 ], b [:,:, 1 ]) x2 = torch . min ( a [:,:, 2 ], b [:,:, 2 ]) y2 = torch . min ( a [:,:, 3 ], b [:,:, 3 ]) inter_w = ( x2 - x1 ) . clamp ( min = 0 ) inter_h = ( y2 - y1 ) . clamp ( min = 0 ) inter = inter_w * inter_h area_a = ( a [:,:, 2 ] - a [:,:, 0 ]) * ( a [:,:, 3 ] - a [:,:, 1 ]) area_b = ( b [:,:, 2 ] - b [:,:, 0 ]) * ( b [:,:, 3 ] - b [:,:, 1 ]) union = area_a + area_b - inter iou = inter / torch . clamp ( union , min = 1e-6 ) return iou","title":"compute_iou2d"},{"location":"Stage1_CandidateMatching/#pair_selector","text":"","title":"pair_selector"},{"location":"Stage1_CandidateMatching/#Stage1_CandidateMatching.operator.pair_selector.pair_selector","text":"\u6839\u636e 2D IoU \u7b5b\u9009\u6709\u6548\u7684 (2D_i, 3D_j) \u914d\u5bf9\uff0c\u5e76\u8fd4\u56de\u5176\u7d22\u5f15\u3002 Parameters: iou_matrix ( Tensor ) \u2013 (K, N) 2D IoU \u77e9\u9635\uff0c\u7b2c i \u884c\u5bf9\u5e94\u7b2c i \u4e2a 2D \u6846\uff0c\u7b2c j \u5217\u5bf9\u5e94\u7b2c j \u4e2a 3D \u6295\u5f71\u6846\u3002 iou_threshold ( float , default: 0.0 ) \u2013 float IoU \u9009\u62e9\u9608\u503c\uff0c\u53ea\u6709 IoU > \u9608\u503c \u7684 (i, j) \u624d\u88ab\u9009\u4e3a\u6709\u6548\u914d\u5bf9\u3002 Returns: pair_indices ( Tensor ) \u2013 (p, 2) \u6bcf\u884c\u8868\u793a\u4e00\u4e2a\u6709\u6548\u914d\u5bf9\uff0c\u683c\u5f0f\u4e3a (i_2d, j_3d)\uff0c\u5171 p \u4e2a\u914d\u5bf9\u3002 Source code in Stage1_CandidateMatching\\operator\\pair_selector.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 @torch . library . custom_op ( \"clocs::pair_selector\" , mutates_args = []) def pair_selector ( iou_matrix : torch . Tensor , iou_threshold : float = 0.0 ) -> torch . Tensor : \"\"\" \u6839\u636e 2D IoU \u7b5b\u9009\u6709\u6548\u7684 (2D_i, 3D_j) \u914d\u5bf9\uff0c\u5e76\u8fd4\u56de\u5176\u7d22\u5f15\u3002 Args: iou_matrix: (K, N) 2D IoU \u77e9\u9635\uff0c\u7b2c i \u884c\u5bf9\u5e94\u7b2c i \u4e2a 2D \u6846\uff0c\u7b2c j \u5217\u5bf9\u5e94\u7b2c j \u4e2a 3D \u6295\u5f71\u6846\u3002 iou_threshold: float IoU \u9009\u62e9\u9608\u503c\uff0c\u53ea\u6709 IoU > \u9608\u503c \u7684 (i, j) \u624d\u88ab\u9009\u4e3a\u6709\u6548\u914d\u5bf9\u3002 Returns: pair_indices: (p, 2) \u6bcf\u884c\u8868\u793a\u4e00\u4e2a\u6709\u6548\u914d\u5bf9\uff0c\u683c\u5f0f\u4e3a (i_2d, j_3d)\uff0c\u5171 p \u4e2a\u914d\u5bf9\u3002 \"\"\" K , N = iou_matrix . shape # \u627e\u51fa\u6240\u6709\u6ee1\u8db3 IoU > threshold \u7684\u4f4d\u7f6e valid = ( iou_matrix > iou_threshold ) # nonzero() \u5f97\u5230\u6240\u6709 (i,j) \u5750\u6807 idx = valid . nonzero ( as_tuple = False ) # [p, 2] return idx","title":"pair_selector"},{"location":"Stage2_PairFeatureBuilding/","text":"Stage 2 \u2014 Pair Feature Building\uff08Pair \u7279\u5f81\u6784\u5efa\uff09 \u00b6 \u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u6839\u636e\u6709\u6548\u7684 2D\u20133D pair \u6784\u9020\u878d\u5408\u7279\u5f81\u5411\u91cf \uff0c\u4e3a\u878d\u5408\u7f51\u7edc\u63d0\u4f9b\u8f93\u5165\u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e00\u4e2a\u7b97\u5b50\uff1a pair_feature_encoder \u6784\u9020\u878d\u5408\u7279\u5f81\u5411\u91cf\uff1a API \u6587\u6863 \u00b6 pair_feature_encoder \u00b6 pair_feature_encoder ( pair_indices , iou_matrix , scores_2d , scores_3d , boxes_3d ) \u00b6 \u6839\u636e pair_indices \u4e3a\u6bcf\u4e2a 2D\u20133D \u914d\u5bf9\u751f\u6210 4 \u7ef4\u878d\u5408\u7279\u5f81\uff1a [IoU2D(i,j), score_3D(j), score_2D(i), distance_3D_center(j)] Parameters: pair_indices ( Tensor ) \u2013 (p, 2) \u6bcf\u884c\u662f\u4e00\u4e2a\u6709\u6548\u914d\u5bf9 (i_2d, j_3d)\u3002 iou_matrix ( Tensor ) \u2013 (K, N) 2D IoU \u77e9\u9635\uff0c\u7b2c i \u884c\u5bf9\u5e94\u7b2c i \u4e2a 2D \u6846\uff0c\u7b2c j \u5217\u5bf9\u5e94\u7b2c j \u4e2a 3D \u6295\u5f71\u6846\u3002 scores_2d ( Tensor ) \u2013 (K) 2D \u68c0\u6d4b\u5668\u7684\u7f6e\u4fe1\u5ea6\u5206\u6570\u3002 scores_3d ( Tensor ) \u2013 (N) 3D \u68c0\u6d4b\u5668\u7684\u7f6e\u4fe1\u5ea6\u5206\u6570\u3002 boxes_3d ( Tensor ) \u2013 (N, 7) 3D \u68c0\u6d4b\u6846\u53c2\u6570 [x, y, z, w, l, h, yaw]\uff0c\u7528\u4e8e\u8ba1\u7b97\u4e2d\u5fc3\u70b9\u8ddd\u79bb\u3002 Returns: pair_features ( Tensor ) \u2013 (4, 1, p) 4 \u4e2a\u901a\u9053\u7684\u878d\u5408\u7279\u5f81\uff0c\u6bcf\u4e2a\u5bf9\u5e94\u4e00\u4e2a pair\u3002 \u7ef4\u5ea6\u987a\u5e8f\u4e3a [\u7279\u5f81\u7ef4\u5ea6, 1, p]\uff0c\u4e0e\u540e\u7eed Conv2d \u8f93\u5165\u683c\u5f0f\u517c\u5bb9\u3002 Source code in Stage2_PairFeatureBuilding\\operator\\pair_feature_encoder.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 @torch . library . custom_op ( \"clocs::pair_feature_encoder\" , mutates_args = []) def pair_feature_encoder ( pair_indices : torch . Tensor , iou_matrix : torch . Tensor , scores_2d : torch . Tensor , scores_3d : torch . Tensor , boxes_3d : torch . Tensor ) -> torch . Tensor : \"\"\" \u6839\u636e pair_indices \u4e3a\u6bcf\u4e2a 2D\u20133D \u914d\u5bf9\u751f\u6210 4 \u7ef4\u878d\u5408\u7279\u5f81\uff1a [IoU2D(i,j), score_3D(j), score_2D(i), distance_3D_center(j)] Args: pair_indices: (p, 2) \u6bcf\u884c\u662f\u4e00\u4e2a\u6709\u6548\u914d\u5bf9 (i_2d, j_3d)\u3002 iou_matrix: (K, N) 2D IoU \u77e9\u9635\uff0c\u7b2c i \u884c\u5bf9\u5e94\u7b2c i \u4e2a 2D \u6846\uff0c\u7b2c j \u5217\u5bf9\u5e94\u7b2c j \u4e2a 3D \u6295\u5f71\u6846\u3002 scores_2d: (K) 2D \u68c0\u6d4b\u5668\u7684\u7f6e\u4fe1\u5ea6\u5206\u6570\u3002 scores_3d: (N) 3D \u68c0\u6d4b\u5668\u7684\u7f6e\u4fe1\u5ea6\u5206\u6570\u3002 boxes_3d: (N, 7) 3D \u68c0\u6d4b\u6846\u53c2\u6570 [x, y, z, w, l, h, yaw]\uff0c\u7528\u4e8e\u8ba1\u7b97\u4e2d\u5fc3\u70b9\u8ddd\u79bb\u3002 Returns: pair_features: (4, 1, p) 4 \u4e2a\u901a\u9053\u7684\u878d\u5408\u7279\u5f81\uff0c\u6bcf\u4e2a\u5bf9\u5e94\u4e00\u4e2a pair\u3002 \u7ef4\u5ea6\u987a\u5e8f\u4e3a [\u7279\u5f81\u7ef4\u5ea6, 1, p]\uff0c\u4e0e\u540e\u7eed Conv2d \u8f93\u5165\u683c\u5f0f\u517c\u5bb9\u3002 \"\"\" idx_i = pair_indices [:, 0 ] # 2D indices, shape [p] idx_j = pair_indices [:, 1 ] # 3D indices, shape [p] # IoU feature iou = iou_matrix [ idx_i , idx_j ] # [p] # Scores s3d = scores_3d [ idx_j ] # [p] s2d = scores_2d [ idx_i ] # [p] # Distance of 3D center centers = boxes_3d [ idx_j , 0 : 3 ] # (p,3) dist = torch . norm ( centers , dim = 1 ) # [p] # Stack features \u2192 [4,p] feats = torch . stack ([ iou , s3d , s2d , dist ], dim = 0 ) # reshape \u2192 [4,1,p] feats = feats . unsqueeze ( 1 ) return feats","title":"Stage2 Pair \u7279\u5f81\u6784\u5efa (Pair Feature Building)"},{"location":"Stage2_PairFeatureBuilding/#stage-2-pair-feature-buildingpair","text":"\u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u6839\u636e\u6709\u6548\u7684 2D\u20133D pair \u6784\u9020\u878d\u5408\u7279\u5f81\u5411\u91cf \uff0c\u4e3a\u878d\u5408\u7f51\u7edc\u63d0\u4f9b\u8f93\u5165\u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e00\u4e2a\u7b97\u5b50\uff1a pair_feature_encoder \u6784\u9020\u878d\u5408\u7279\u5f81\u5411\u91cf\uff1a","title":"Stage 2 \u2014 Pair Feature Building\uff08Pair \u7279\u5f81\u6784\u5efa\uff09"},{"location":"Stage2_PairFeatureBuilding/#api","text":"","title":"API \u6587\u6863"},{"location":"Stage2_PairFeatureBuilding/#pair_feature_encoder","text":"","title":"pair_feature_encoder"},{"location":"Stage2_PairFeatureBuilding/#Stage2_PairFeatureBuilding.operator.pair_feature_encoder.pair_feature_encoder","text":"\u6839\u636e pair_indices \u4e3a\u6bcf\u4e2a 2D\u20133D \u914d\u5bf9\u751f\u6210 4 \u7ef4\u878d\u5408\u7279\u5f81\uff1a [IoU2D(i,j), score_3D(j), score_2D(i), distance_3D_center(j)] Parameters: pair_indices ( Tensor ) \u2013 (p, 2) \u6bcf\u884c\u662f\u4e00\u4e2a\u6709\u6548\u914d\u5bf9 (i_2d, j_3d)\u3002 iou_matrix ( Tensor ) \u2013 (K, N) 2D IoU \u77e9\u9635\uff0c\u7b2c i \u884c\u5bf9\u5e94\u7b2c i \u4e2a 2D \u6846\uff0c\u7b2c j \u5217\u5bf9\u5e94\u7b2c j \u4e2a 3D \u6295\u5f71\u6846\u3002 scores_2d ( Tensor ) \u2013 (K) 2D \u68c0\u6d4b\u5668\u7684\u7f6e\u4fe1\u5ea6\u5206\u6570\u3002 scores_3d ( Tensor ) \u2013 (N) 3D \u68c0\u6d4b\u5668\u7684\u7f6e\u4fe1\u5ea6\u5206\u6570\u3002 boxes_3d ( Tensor ) \u2013 (N, 7) 3D \u68c0\u6d4b\u6846\u53c2\u6570 [x, y, z, w, l, h, yaw]\uff0c\u7528\u4e8e\u8ba1\u7b97\u4e2d\u5fc3\u70b9\u8ddd\u79bb\u3002 Returns: pair_features ( Tensor ) \u2013 (4, 1, p) 4 \u4e2a\u901a\u9053\u7684\u878d\u5408\u7279\u5f81\uff0c\u6bcf\u4e2a\u5bf9\u5e94\u4e00\u4e2a pair\u3002 \u7ef4\u5ea6\u987a\u5e8f\u4e3a [\u7279\u5f81\u7ef4\u5ea6, 1, p]\uff0c\u4e0e\u540e\u7eed Conv2d \u8f93\u5165\u683c\u5f0f\u517c\u5bb9\u3002 Source code in Stage2_PairFeatureBuilding\\operator\\pair_feature_encoder.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 @torch . library . custom_op ( \"clocs::pair_feature_encoder\" , mutates_args = []) def pair_feature_encoder ( pair_indices : torch . Tensor , iou_matrix : torch . Tensor , scores_2d : torch . Tensor , scores_3d : torch . Tensor , boxes_3d : torch . Tensor ) -> torch . Tensor : \"\"\" \u6839\u636e pair_indices \u4e3a\u6bcf\u4e2a 2D\u20133D \u914d\u5bf9\u751f\u6210 4 \u7ef4\u878d\u5408\u7279\u5f81\uff1a [IoU2D(i,j), score_3D(j), score_2D(i), distance_3D_center(j)] Args: pair_indices: (p, 2) \u6bcf\u884c\u662f\u4e00\u4e2a\u6709\u6548\u914d\u5bf9 (i_2d, j_3d)\u3002 iou_matrix: (K, N) 2D IoU \u77e9\u9635\uff0c\u7b2c i \u884c\u5bf9\u5e94\u7b2c i \u4e2a 2D \u6846\uff0c\u7b2c j \u5217\u5bf9\u5e94\u7b2c j \u4e2a 3D \u6295\u5f71\u6846\u3002 scores_2d: (K) 2D \u68c0\u6d4b\u5668\u7684\u7f6e\u4fe1\u5ea6\u5206\u6570\u3002 scores_3d: (N) 3D \u68c0\u6d4b\u5668\u7684\u7f6e\u4fe1\u5ea6\u5206\u6570\u3002 boxes_3d: (N, 7) 3D \u68c0\u6d4b\u6846\u53c2\u6570 [x, y, z, w, l, h, yaw]\uff0c\u7528\u4e8e\u8ba1\u7b97\u4e2d\u5fc3\u70b9\u8ddd\u79bb\u3002 Returns: pair_features: (4, 1, p) 4 \u4e2a\u901a\u9053\u7684\u878d\u5408\u7279\u5f81\uff0c\u6bcf\u4e2a\u5bf9\u5e94\u4e00\u4e2a pair\u3002 \u7ef4\u5ea6\u987a\u5e8f\u4e3a [\u7279\u5f81\u7ef4\u5ea6, 1, p]\uff0c\u4e0e\u540e\u7eed Conv2d \u8f93\u5165\u683c\u5f0f\u517c\u5bb9\u3002 \"\"\" idx_i = pair_indices [:, 0 ] # 2D indices, shape [p] idx_j = pair_indices [:, 1 ] # 3D indices, shape [p] # IoU feature iou = iou_matrix [ idx_i , idx_j ] # [p] # Scores s3d = scores_3d [ idx_j ] # [p] s2d = scores_2d [ idx_i ] # [p] # Distance of 3D center centers = boxes_3d [ idx_j , 0 : 3 ] # (p,3) dist = torch . norm ( centers , dim = 1 ) # [p] # Stack features \u2192 [4,p] feats = torch . stack ([ iou , s3d , s2d , dist ], dim = 0 ) # reshape \u2192 [4,1,p] feats = feats . unsqueeze ( 1 ) return feats","title":"pair_feature_encoder"},{"location":"Stage3_FusionMLP/","text":"Stage 3 \u2014 FusionMLP\uff08\u878d\u5408 MLP \u7f51\u7edc\uff09 \u00b6 \u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u5bf9\u6bcf\u4e2a 2D\u20133D pair \u7684\u7279\u5f81\u8fdb\u884c\u8bc4\u5206 \uff0c\u5f97\u5230 pair-level \u7684\u878d\u5408\u5f97\u5206\u3002 \u8be5\u9636\u6bb5\u5305\u542b\u4e00\u4e2a\u53ef\u5b66\u4e60\u6a21\u5757\uff1a FusionMLP \u4f7f\u7528 Conv1\u00d71 \u5c42\u5bf9 pair \u7279\u5f81\u8fdb\u884c\u878d\u5408\u9884\u6d4b\uff0c\u751f\u6210 pair-level score\u3002 API \u6587\u6863 \u00b6 FusionMLP \u00b6 Bases: Module FusionMLP \u6a21\u5757\uff08CLOCs_LQS \u878d\u5408\u9636\u6bb5\u6838\u5fc3\u7b97\u5b50\uff09\u3002 \u8be5\u6a21\u5757\u5bf9\u6bcf\u4e2a (2D\u20133D Pair) \u7684\u878d\u5408\u7279\u5f81\u8fdb\u884c\u975e\u7ebf\u6027\u6620\u5c04\uff0c\u7528\u4e8e\u5b66\u4e60 2D \u68c0\u6d4b\u5668\u4e0e 3D \u68c0\u6d4b\u5668\u4e4b\u95f4\u7684 \u5173\u8054\u5173\u7cfb\u3002\u5176\u672c\u8d28\u662f\u7531\u591a\u4e2a 1\u00d71 \u5377\u79ef\u5c42\u7ec4\u6210\u7684 MLP\uff0c\u80fd\u591f\u5728\u4e0d\u6539\u53d8\u7279\u5f81\u7a7a\u95f4\u51e0\u4f55\u7ed3\u6784\u7684\u60c5\u51b5\u4e0b\uff0c \u5bf9\u6bcf\u4e2a pair \u8fdb\u884c\u9010\u70b9\u7279\u5f81\u53d8\u6362\uff0c\u4ece\u800c\u8f93\u51fa\u878d\u5408\u540e\u7684 pair-level \u5f97\u5206\u3002 \u672c\u6a21\u5757\u5c5e\u4e8e \u53ef\u5b66\u4e60\u7b97\u5b50 \uff0c\u5176\u53c2\u6570\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u6839\u636e\u76d1\u7763\u4fe1\u53f7\u66f4\u65b0\u3002 \u7ed3\u6784\u8bf4\u660e\uff08\u6309\u987a\u5e8f\uff09 \u00b6 Conv2d 4 \u2192 18, kernel=1 \u521d\u6b65\u6620\u5c04 4 \u7ef4\u878d\u5408\u7279\u5f81\uff08IoU\u2082D\u3001score\u2082D\u3001score\u2083D\u3001distance\u2083D\uff09\u3002 ReLU \u6fc0\u6d3b Conv2d 18 \u2192 36, kernel=1 \u52a0\u5f3a\u7279\u5f81\u8868\u8fbe\u80fd\u529b\u3002 ReLU \u6fc0\u6d3b Conv2d 36 \u2192 36, kernel=1 \u975e\u7ebf\u6027\u53d8\u6362\uff0c\u63d0\u5347 pair \u8bed\u4e49\u533a\u5206\u80fd\u529b\u3002 ReLU \u6fc0\u6d3b Conv2d 36 \u2192 1, kernel=1 \u8f93\u51fa\u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 \u8f93\u5165 \u00b6 Args: pair_features (torch.Tensor): Pair \u7279\u5f81\u5f20\u91cf\uff0cshape \u4e3a (B, 4, 1, p) - B\uff1abatch size - 4\uff1a\u878d\u5408\u7279\u5f81\u7ef4\u5ea6\uff08IoU\u2082D\u3001score\u2083D\u3001score\u2082D\u3001distance\u2083D\uff09 - 1\uff1a\u56fa\u5b9a spatial \u7ef4 - p\uff1apair \u6570\u91cf \u8f93\u51fa \u00b6 Returns: torch.Tensor: \u878d\u5408\u540e\u7684 pair-level \u5f97\u5206\uff0cshape\uff1a (B, 1, 1, p) \u6a21\u5757\u7528\u9014 \u00b6 \u4e3a\u6bcf\u4e2a (2D \u68c0\u6d4b\u6846, 3D \u68c0\u6d4b\u6846) \u751f\u6210\u4e00\u4e2a\u878d\u5408\u5f97\u5206 \u6839\u636e MLP \u5b66\u4e60\u5230\u7684 2D/3D \u4fe1\u606f\u5173\u8054\u89c4\u5219\uff0c\u63d0\u5347\u6700\u7ec8 3D \u68c0\u6d4b\u7ed3\u679c\u7684\u6392\u5e8f\u548c\u7f6e\u4fe1\u5ea6\u4f30\u8ba1 \u5c5e\u4e8e CLOCs_LQS \u7684 Stage3\uff1aFusionMLP \u6838\u5fc3\u90e8\u5206 Source code in Stage3_FusionMLP\\network\\FusionMLP.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 class FusionMLP ( nn . Module ): \"\"\" FusionMLP \u6a21\u5757\uff08CLOCs_LQS \u878d\u5408\u9636\u6bb5\u6838\u5fc3\u7b97\u5b50\uff09\u3002 \u8be5\u6a21\u5757\u5bf9\u6bcf\u4e2a (2D\u20133D Pair) \u7684\u878d\u5408\u7279\u5f81\u8fdb\u884c\u975e\u7ebf\u6027\u6620\u5c04\uff0c\u7528\u4e8e\u5b66\u4e60 2D \u68c0\u6d4b\u5668\u4e0e 3D \u68c0\u6d4b\u5668\u4e4b\u95f4\u7684 \u5173\u8054\u5173\u7cfb\u3002\u5176\u672c\u8d28\u662f\u7531\u591a\u4e2a `1\u00d71` \u5377\u79ef\u5c42\u7ec4\u6210\u7684 MLP\uff0c\u80fd\u591f\u5728\u4e0d\u6539\u53d8\u7279\u5f81\u7a7a\u95f4\u51e0\u4f55\u7ed3\u6784\u7684\u60c5\u51b5\u4e0b\uff0c \u5bf9\u6bcf\u4e2a pair \u8fdb\u884c\u9010\u70b9\u7279\u5f81\u53d8\u6362\uff0c\u4ece\u800c\u8f93\u51fa\u878d\u5408\u540e\u7684 pair-level \u5f97\u5206\u3002 \u672c\u6a21\u5757\u5c5e\u4e8e **\u53ef\u5b66\u4e60\u7b97\u5b50**\uff0c\u5176\u53c2\u6570\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u6839\u636e\u76d1\u7763\u4fe1\u53f7\u66f4\u65b0\u3002 --- ### \u7ed3\u6784\u8bf4\u660e\uff08\u6309\u987a\u5e8f\uff09 1. **Conv2d 4 \u2192 18, kernel=1** - \u521d\u6b65\u6620\u5c04 4 \u7ef4\u878d\u5408\u7279\u5f81\uff08IoU\u2082D\u3001score\u2082D\u3001score\u2083D\u3001distance\u2083D\uff09\u3002 2. **ReLU \u6fc0\u6d3b** 3. **Conv2d 18 \u2192 36, kernel=1** - \u52a0\u5f3a\u7279\u5f81\u8868\u8fbe\u80fd\u529b\u3002 4. **ReLU \u6fc0\u6d3b** 5. **Conv2d 36 \u2192 36, kernel=1** - \u975e\u7ebf\u6027\u53d8\u6362\uff0c\u63d0\u5347 pair \u8bed\u4e49\u533a\u5206\u80fd\u529b\u3002 6. **ReLU \u6fc0\u6d3b** 7. **Conv2d 36 \u2192 1, kernel=1** - \u8f93\u51fa\u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 --- ### \u8f93\u5165 Args: pair_features (torch.Tensor): Pair \u7279\u5f81\u5f20\u91cf\uff0cshape \u4e3a **(B, 4, 1, p)** - B\uff1abatch size - 4\uff1a\u878d\u5408\u7279\u5f81\u7ef4\u5ea6\uff08IoU\u2082D\u3001score\u2083D\u3001score\u2082D\u3001distance\u2083D\uff09 - 1\uff1a\u56fa\u5b9a spatial \u7ef4 - p\uff1apair \u6570\u91cf --- ### \u8f93\u51fa Returns: torch.Tensor: \u878d\u5408\u540e\u7684 pair-level \u5f97\u5206\uff0cshape\uff1a**(B, 1, 1, p)** --- ### \u6a21\u5757\u7528\u9014 - \u4e3a\u6bcf\u4e2a (2D \u68c0\u6d4b\u6846, 3D \u68c0\u6d4b\u6846) \u751f\u6210\u4e00\u4e2a\u878d\u5408\u5f97\u5206 - \u6839\u636e MLP \u5b66\u4e60\u5230\u7684 2D/3D \u4fe1\u606f\u5173\u8054\u89c4\u5219\uff0c\u63d0\u5347\u6700\u7ec8 3D \u68c0\u6d4b\u7ed3\u679c\u7684\u6392\u5e8f\u548c\u7f6e\u4fe1\u5ea6\u4f30\u8ba1 - \u5c5e\u4e8e CLOCs_LQS \u7684 Stage3\uff1aFusionMLP \u6838\u5fc3\u90e8\u5206 \"\"\" def __init__ ( self , in_channels : int = 4 , mid_channels1 : int = 18 , mid_channels2 : int = 36 , mid_channels3 : int = 36 ): super () . __init__ () self . mlp = nn . Sequential ( nn . Conv2d ( in_channels , mid_channels1 , 1 ), nn . ReLU (), nn . Conv2d ( mid_channels1 , mid_channels2 , 1 ), nn . ReLU (), nn . Conv2d ( mid_channels2 , mid_channels3 , 1 ), nn . ReLU (), nn . Conv2d ( mid_channels3 , 1 , 1 ) ) def forward ( self , pair_features : torch . Tensor ) -> torch . Tensor : \"\"\" \u524d\u5411\u4f20\u64ad\uff0c\u8ba1\u7b97\u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 Args: pair_features (torch.Tensor): \u8f93\u5165\u7684 pair \u7279\u5f81 (B, 4, 1, p)\u3002 Returns: torch.Tensor: \u8f93\u51fa\u7684\u878d\u5408\u5f97\u5206 (B, 1, 1, p)\u3002 \"\"\" return self . mlp ( pair_features ) forward ( pair_features ) \u00b6 \u524d\u5411\u4f20\u64ad\uff0c\u8ba1\u7b97\u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 Parameters: pair_features ( Tensor ) \u2013 \u8f93\u5165\u7684 pair \u7279\u5f81 (B, 4, 1, p)\u3002 Returns: Tensor \u2013 torch.Tensor: \u8f93\u51fa\u7684\u878d\u5408\u5f97\u5206 (B, 1, 1, p)\u3002 Source code in Stage3_FusionMLP\\network\\FusionMLP.py 67 68 69 70 71 72 73 74 75 76 77 78 79 def forward ( self , pair_features : torch . Tensor ) -> torch . Tensor : \"\"\" \u524d\u5411\u4f20\u64ad\uff0c\u8ba1\u7b97\u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 Args: pair_features (torch.Tensor): \u8f93\u5165\u7684 pair \u7279\u5f81 (B, 4, 1, p)\u3002 Returns: torch.Tensor: \u8f93\u51fa\u7684\u878d\u5408\u5f97\u5206 (B, 1, 1, p)\u3002 \"\"\" return self . mlp ( pair_features )","title":"Stage3 FusionMLP \u878d\u5408\u7f51\u7edc"},{"location":"Stage3_FusionMLP/#stage-3-fusionmlp-mlp","text":"\u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u5bf9\u6bcf\u4e2a 2D\u20133D pair \u7684\u7279\u5f81\u8fdb\u884c\u8bc4\u5206 \uff0c\u5f97\u5230 pair-level \u7684\u878d\u5408\u5f97\u5206\u3002 \u8be5\u9636\u6bb5\u5305\u542b\u4e00\u4e2a\u53ef\u5b66\u4e60\u6a21\u5757\uff1a FusionMLP \u4f7f\u7528 Conv1\u00d71 \u5c42\u5bf9 pair \u7279\u5f81\u8fdb\u884c\u878d\u5408\u9884\u6d4b\uff0c\u751f\u6210 pair-level score\u3002","title":"Stage 3 \u2014 FusionMLP\uff08\u878d\u5408 MLP \u7f51\u7edc\uff09"},{"location":"Stage3_FusionMLP/#api","text":"","title":"API \u6587\u6863"},{"location":"Stage3_FusionMLP/#fusionmlp","text":"Bases: Module FusionMLP \u6a21\u5757\uff08CLOCs_LQS \u878d\u5408\u9636\u6bb5\u6838\u5fc3\u7b97\u5b50\uff09\u3002 \u8be5\u6a21\u5757\u5bf9\u6bcf\u4e2a (2D\u20133D Pair) \u7684\u878d\u5408\u7279\u5f81\u8fdb\u884c\u975e\u7ebf\u6027\u6620\u5c04\uff0c\u7528\u4e8e\u5b66\u4e60 2D \u68c0\u6d4b\u5668\u4e0e 3D \u68c0\u6d4b\u5668\u4e4b\u95f4\u7684 \u5173\u8054\u5173\u7cfb\u3002\u5176\u672c\u8d28\u662f\u7531\u591a\u4e2a 1\u00d71 \u5377\u79ef\u5c42\u7ec4\u6210\u7684 MLP\uff0c\u80fd\u591f\u5728\u4e0d\u6539\u53d8\u7279\u5f81\u7a7a\u95f4\u51e0\u4f55\u7ed3\u6784\u7684\u60c5\u51b5\u4e0b\uff0c \u5bf9\u6bcf\u4e2a pair \u8fdb\u884c\u9010\u70b9\u7279\u5f81\u53d8\u6362\uff0c\u4ece\u800c\u8f93\u51fa\u878d\u5408\u540e\u7684 pair-level \u5f97\u5206\u3002 \u672c\u6a21\u5757\u5c5e\u4e8e \u53ef\u5b66\u4e60\u7b97\u5b50 \uff0c\u5176\u53c2\u6570\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u6839\u636e\u76d1\u7763\u4fe1\u53f7\u66f4\u65b0\u3002","title":"FusionMLP"},{"location":"Stage3_FusionMLP/#Stage3_FusionMLP.network.FusionMLP.FusionMLP--_1","text":"Conv2d 4 \u2192 18, kernel=1 \u521d\u6b65\u6620\u5c04 4 \u7ef4\u878d\u5408\u7279\u5f81\uff08IoU\u2082D\u3001score\u2082D\u3001score\u2083D\u3001distance\u2083D\uff09\u3002 ReLU \u6fc0\u6d3b Conv2d 18 \u2192 36, kernel=1 \u52a0\u5f3a\u7279\u5f81\u8868\u8fbe\u80fd\u529b\u3002 ReLU \u6fc0\u6d3b Conv2d 36 \u2192 36, kernel=1 \u975e\u7ebf\u6027\u53d8\u6362\uff0c\u63d0\u5347 pair \u8bed\u4e49\u533a\u5206\u80fd\u529b\u3002 ReLU \u6fc0\u6d3b Conv2d 36 \u2192 1, kernel=1 \u8f93\u51fa\u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002","title":"\u7ed3\u6784\u8bf4\u660e\uff08\u6309\u987a\u5e8f\uff09"},{"location":"Stage3_FusionMLP/#Stage3_FusionMLP.network.FusionMLP.FusionMLP--_2","text":"Args: pair_features (torch.Tensor): Pair \u7279\u5f81\u5f20\u91cf\uff0cshape \u4e3a (B, 4, 1, p) - B\uff1abatch size - 4\uff1a\u878d\u5408\u7279\u5f81\u7ef4\u5ea6\uff08IoU\u2082D\u3001score\u2083D\u3001score\u2082D\u3001distance\u2083D\uff09 - 1\uff1a\u56fa\u5b9a spatial \u7ef4 - p\uff1apair \u6570\u91cf","title":"\u8f93\u5165"},{"location":"Stage3_FusionMLP/#Stage3_FusionMLP.network.FusionMLP.FusionMLP--_3","text":"Returns: torch.Tensor: \u878d\u5408\u540e\u7684 pair-level \u5f97\u5206\uff0cshape\uff1a (B, 1, 1, p)","title":"\u8f93\u51fa"},{"location":"Stage3_FusionMLP/#Stage3_FusionMLP.network.FusionMLP.FusionMLP--_4","text":"\u4e3a\u6bcf\u4e2a (2D \u68c0\u6d4b\u6846, 3D \u68c0\u6d4b\u6846) \u751f\u6210\u4e00\u4e2a\u878d\u5408\u5f97\u5206 \u6839\u636e MLP \u5b66\u4e60\u5230\u7684 2D/3D \u4fe1\u606f\u5173\u8054\u89c4\u5219\uff0c\u63d0\u5347\u6700\u7ec8 3D \u68c0\u6d4b\u7ed3\u679c\u7684\u6392\u5e8f\u548c\u7f6e\u4fe1\u5ea6\u4f30\u8ba1 \u5c5e\u4e8e CLOCs_LQS \u7684 Stage3\uff1aFusionMLP \u6838\u5fc3\u90e8\u5206 Source code in Stage3_FusionMLP\\network\\FusionMLP.py 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 class FusionMLP ( nn . Module ): \"\"\" FusionMLP \u6a21\u5757\uff08CLOCs_LQS \u878d\u5408\u9636\u6bb5\u6838\u5fc3\u7b97\u5b50\uff09\u3002 \u8be5\u6a21\u5757\u5bf9\u6bcf\u4e2a (2D\u20133D Pair) \u7684\u878d\u5408\u7279\u5f81\u8fdb\u884c\u975e\u7ebf\u6027\u6620\u5c04\uff0c\u7528\u4e8e\u5b66\u4e60 2D \u68c0\u6d4b\u5668\u4e0e 3D \u68c0\u6d4b\u5668\u4e4b\u95f4\u7684 \u5173\u8054\u5173\u7cfb\u3002\u5176\u672c\u8d28\u662f\u7531\u591a\u4e2a `1\u00d71` \u5377\u79ef\u5c42\u7ec4\u6210\u7684 MLP\uff0c\u80fd\u591f\u5728\u4e0d\u6539\u53d8\u7279\u5f81\u7a7a\u95f4\u51e0\u4f55\u7ed3\u6784\u7684\u60c5\u51b5\u4e0b\uff0c \u5bf9\u6bcf\u4e2a pair \u8fdb\u884c\u9010\u70b9\u7279\u5f81\u53d8\u6362\uff0c\u4ece\u800c\u8f93\u51fa\u878d\u5408\u540e\u7684 pair-level \u5f97\u5206\u3002 \u672c\u6a21\u5757\u5c5e\u4e8e **\u53ef\u5b66\u4e60\u7b97\u5b50**\uff0c\u5176\u53c2\u6570\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u6839\u636e\u76d1\u7763\u4fe1\u53f7\u66f4\u65b0\u3002 --- ### \u7ed3\u6784\u8bf4\u660e\uff08\u6309\u987a\u5e8f\uff09 1. **Conv2d 4 \u2192 18, kernel=1** - \u521d\u6b65\u6620\u5c04 4 \u7ef4\u878d\u5408\u7279\u5f81\uff08IoU\u2082D\u3001score\u2082D\u3001score\u2083D\u3001distance\u2083D\uff09\u3002 2. **ReLU \u6fc0\u6d3b** 3. **Conv2d 18 \u2192 36, kernel=1** - \u52a0\u5f3a\u7279\u5f81\u8868\u8fbe\u80fd\u529b\u3002 4. **ReLU \u6fc0\u6d3b** 5. **Conv2d 36 \u2192 36, kernel=1** - \u975e\u7ebf\u6027\u53d8\u6362\uff0c\u63d0\u5347 pair \u8bed\u4e49\u533a\u5206\u80fd\u529b\u3002 6. **ReLU \u6fc0\u6d3b** 7. **Conv2d 36 \u2192 1, kernel=1** - \u8f93\u51fa\u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 --- ### \u8f93\u5165 Args: pair_features (torch.Tensor): Pair \u7279\u5f81\u5f20\u91cf\uff0cshape \u4e3a **(B, 4, 1, p)** - B\uff1abatch size - 4\uff1a\u878d\u5408\u7279\u5f81\u7ef4\u5ea6\uff08IoU\u2082D\u3001score\u2083D\u3001score\u2082D\u3001distance\u2083D\uff09 - 1\uff1a\u56fa\u5b9a spatial \u7ef4 - p\uff1apair \u6570\u91cf --- ### \u8f93\u51fa Returns: torch.Tensor: \u878d\u5408\u540e\u7684 pair-level \u5f97\u5206\uff0cshape\uff1a**(B, 1, 1, p)** --- ### \u6a21\u5757\u7528\u9014 - \u4e3a\u6bcf\u4e2a (2D \u68c0\u6d4b\u6846, 3D \u68c0\u6d4b\u6846) \u751f\u6210\u4e00\u4e2a\u878d\u5408\u5f97\u5206 - \u6839\u636e MLP \u5b66\u4e60\u5230\u7684 2D/3D \u4fe1\u606f\u5173\u8054\u89c4\u5219\uff0c\u63d0\u5347\u6700\u7ec8 3D \u68c0\u6d4b\u7ed3\u679c\u7684\u6392\u5e8f\u548c\u7f6e\u4fe1\u5ea6\u4f30\u8ba1 - \u5c5e\u4e8e CLOCs_LQS \u7684 Stage3\uff1aFusionMLP \u6838\u5fc3\u90e8\u5206 \"\"\" def __init__ ( self , in_channels : int = 4 , mid_channels1 : int = 18 , mid_channels2 : int = 36 , mid_channels3 : int = 36 ): super () . __init__ () self . mlp = nn . Sequential ( nn . Conv2d ( in_channels , mid_channels1 , 1 ), nn . ReLU (), nn . Conv2d ( mid_channels1 , mid_channels2 , 1 ), nn . ReLU (), nn . Conv2d ( mid_channels2 , mid_channels3 , 1 ), nn . ReLU (), nn . Conv2d ( mid_channels3 , 1 , 1 ) ) def forward ( self , pair_features : torch . Tensor ) -> torch . Tensor : \"\"\" \u524d\u5411\u4f20\u64ad\uff0c\u8ba1\u7b97\u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 Args: pair_features (torch.Tensor): \u8f93\u5165\u7684 pair \u7279\u5f81 (B, 4, 1, p)\u3002 Returns: torch.Tensor: \u8f93\u51fa\u7684\u878d\u5408\u5f97\u5206 (B, 1, 1, p)\u3002 \"\"\" return self . mlp ( pair_features )","title":"\u6a21\u5757\u7528\u9014"},{"location":"Stage3_FusionMLP/#Stage3_FusionMLP.network.FusionMLP.FusionMLP.forward","text":"\u524d\u5411\u4f20\u64ad\uff0c\u8ba1\u7b97\u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 Parameters: pair_features ( Tensor ) \u2013 \u8f93\u5165\u7684 pair \u7279\u5f81 (B, 4, 1, p)\u3002 Returns: Tensor \u2013 torch.Tensor: \u8f93\u51fa\u7684\u878d\u5408\u5f97\u5206 (B, 1, 1, p)\u3002 Source code in Stage3_FusionMLP\\network\\FusionMLP.py 67 68 69 70 71 72 73 74 75 76 77 78 79 def forward ( self , pair_features : torch . Tensor ) -> torch . Tensor : \"\"\" \u524d\u5411\u4f20\u64ad\uff0c\u8ba1\u7b97\u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 Args: pair_features (torch.Tensor): \u8f93\u5165\u7684 pair \u7279\u5f81 (B, 4, 1, p)\u3002 Returns: torch.Tensor: \u8f93\u51fa\u7684\u878d\u5408\u5f97\u5206 (B, 1, 1, p)\u3002 \"\"\" return self . mlp ( pair_features )","title":"forward"},{"location":"Stage4_ScoreAggregation/","text":"Stage 4 \u2014 Score Aggregation\uff08\u878d\u5408\u5f97\u5206\u805a\u5408\uff09 \u00b6 \u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u5c06 pair-level \u5f97\u5206\u6620\u5c04\u56de\u539f\u59cb 3D \u68c0\u6d4b\u6846 , \u5f97\u5230\u6700\u7ec8\u7684\u6bcf\u4e2a 3D \u6846\u7684\u878d\u5408\u5206\u6570\u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e24\u4e2a\u7b97\u5b50\uff1a scatter_to_matrix \u5c06 p \u4e2a pair \u5f97\u5206\u6620\u5c04\u56de (K\u00d7N) score matrix\u3002 score_aggregator \u6cbf 2D \u7ef4\u5ea6 MaxPool \u5f97\u5230\u6700\u7ec8 N \u4e2a\u878d\u5408\u5f97\u5206\u3002 API \u6587\u6863 \u00b6 scatter_to_matrix \u00b6 scatter_to_matrix ( pair_scores , pair_indices , K , N ) \u00b6 \u5c06 p \u4e2a pair \u5f97\u5206\u6839\u636e pair_indices \u6563\u5c04\u56de (1, K, N) \u7684\u5f97\u5206\u77e9\u9635\u3002 \u5bf9\u4e8e\u6ca1\u6709\u5bf9\u5e94 pair \u7684\u4f4d\u7f6e\u586b\u5145\u4e00\u4e2a\u6781\u5c0f\u503c\u3002 Parameters: pair_scores ( Tensor ) \u2013 (p,) \u6216 (1,1,p) \u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 pair_indices ( Tensor ) \u2013 (p,2) \u6bcf\u884c (i_2d, j_3d) \u8868\u793a\u8be5 score \u5e94\u5199\u5165\u77e9\u9635\u4f4d\u7f6e (i, j)\u3002 K ( int ) \u2013 int \u672c\u5e27 2D \u6846\u6570\u91cf\u4e0a\u9650\u3002 N ( int ) \u2013 int \u672c\u5e27 3D \u6846\u6570\u91cf\u4e0a\u9650\u3002 Returns: score_matrix ( Tensor ) \u2013 (1, K, N) \u5bf9\u5e94\u4f4d\u7f6e\u5199\u5165 pair score\uff0c\u5176\u4f59\u4f4d\u7f6e\u4e3a\u8d1f\u65e0\u7a77\u5c0f\u3002 Source code in Stage4_ScoreAggregation\\operator\\scatter_to_matrix.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 @torch . library . custom_op ( \"clocs::scatter_to_matrix\" , mutates_args = []) def scatter_to_matrix ( pair_scores : torch . Tensor , pair_indices : torch . Tensor , K : int , N : int ) -> torch . Tensor : \"\"\" \u5c06 p \u4e2a pair \u5f97\u5206\u6839\u636e pair_indices \u6563\u5c04\u56de (1, K, N) \u7684\u5f97\u5206\u77e9\u9635\u3002 \u5bf9\u4e8e\u6ca1\u6709\u5bf9\u5e94 pair \u7684\u4f4d\u7f6e\u586b\u5145\u4e00\u4e2a\u6781\u5c0f\u503c\u3002 Args: pair_scores: (p,) \u6216 (1,1,p) \u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 pair_indices: (p,2) \u6bcf\u884c (i_2d, j_3d) \u8868\u793a\u8be5 score \u5e94\u5199\u5165\u77e9\u9635\u4f4d\u7f6e (i, j)\u3002 K: int \u672c\u5e27 2D \u6846\u6570\u91cf\u4e0a\u9650\u3002 N: int \u672c\u5e27 3D \u6846\u6570\u91cf\u4e0a\u9650\u3002 Returns: score_matrix: (1, K, N) \u5bf9\u5e94\u4f4d\u7f6e\u5199\u5165 pair score\uff0c\u5176\u4f59\u4f4d\u7f6e\u4e3a\u8d1f\u65e0\u7a77\u5c0f\u3002 \"\"\" # \u517c\u5bb9\u8f93\u5165\u4e3a (1,1,p) \u6216 (p,) if pair_scores . ndim == 3 : pair_scores = pair_scores . squeeze () score_matrix = torch . full ( ( 1 , K , N ), - 1e7 , device = pair_scores . device ) i_idx = pair_indices [:, 0 ] j_idx = pair_indices [:, 1 ] score_matrix [ 0 , i_idx , j_idx ] = pair_scores return score_matrix score_aggregator \u00b6 score_aggregator ( score_matrix ) \u00b6 \u5bf9 score_matrix (1, K, N) \u5728 2D \u7ef4\u5ea6\u4e0a\u505a\u6700\u5927\u6c60\u5316\uff0c \u4e3a\u6bcf\u4e2a 3D \u6846\u5f97\u5230\u552f\u4e00\u878d\u5408\u5f97\u5206\u3002 Parameters: score_matrix ( Tensor ) \u2013 (1, K, N) \u6765\u81ea scatter_to_matrix \u7684\u5f97\u5206\u77e9\u9635\u3002 Returns: fused_scores ( Tensor ) \u2013 (N) \u6bcf\u4e2a 3D \u6846\u7684\u878d\u5408\u7f6e\u4fe1\u5ea6\uff0c\u53d6 score_matrix \u5728 K \u7ef4\u7684\u6700\u5927\u503c\u3002 Source code in Stage4_ScoreAggregation\\operator\\score_aggregator.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 @torch . library . custom_op ( \"clocs::score_aggregator\" , mutates_args = []) def score_aggregator ( score_matrix : torch . Tensor ) -> torch . Tensor : \"\"\" \u5bf9 score_matrix (1, K, N) \u5728 2D \u7ef4\u5ea6\u4e0a\u505a\u6700\u5927\u6c60\u5316\uff0c \u4e3a\u6bcf\u4e2a 3D \u6846\u5f97\u5230\u552f\u4e00\u878d\u5408\u5f97\u5206\u3002 Args: score_matrix: (1, K, N) \u6765\u81ea scatter_to_matrix \u7684\u5f97\u5206\u77e9\u9635\u3002 Returns: fused_scores: (N) \u6bcf\u4e2a 3D \u6846\u7684\u878d\u5408\u7f6e\u4fe1\u5ea6\uff0c\u53d6 score_matrix \u5728 K \u7ef4\u7684\u6700\u5927\u503c\u3002 \"\"\" # score_matrix: [1, K, N] fused_scores , _ = score_matrix . max ( dim = 1 ) # \u2192 [1, N] # squeeze \u2192 [N] fused_scores = fused_scores . squeeze ( 0 ) return fused_scores","title":"Stage4 \u5f97\u5206\u805a\u5408 (Score Aggregation)"},{"location":"Stage4_ScoreAggregation/#stage-4-score-aggregation","text":"\u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u5c06 pair-level \u5f97\u5206\u6620\u5c04\u56de\u539f\u59cb 3D \u68c0\u6d4b\u6846 , \u5f97\u5230\u6700\u7ec8\u7684\u6bcf\u4e2a 3D \u6846\u7684\u878d\u5408\u5206\u6570\u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e24\u4e2a\u7b97\u5b50\uff1a scatter_to_matrix \u5c06 p \u4e2a pair \u5f97\u5206\u6620\u5c04\u56de (K\u00d7N) score matrix\u3002 score_aggregator \u6cbf 2D \u7ef4\u5ea6 MaxPool \u5f97\u5230\u6700\u7ec8 N \u4e2a\u878d\u5408\u5f97\u5206\u3002","title":"Stage 4 \u2014 Score Aggregation\uff08\u878d\u5408\u5f97\u5206\u805a\u5408\uff09"},{"location":"Stage4_ScoreAggregation/#api","text":"","title":"API \u6587\u6863"},{"location":"Stage4_ScoreAggregation/#scatter_to_matrix","text":"","title":"scatter_to_matrix"},{"location":"Stage4_ScoreAggregation/#Stage4_ScoreAggregation.operator.scatter_to_matrix.scatter_to_matrix","text":"\u5c06 p \u4e2a pair \u5f97\u5206\u6839\u636e pair_indices \u6563\u5c04\u56de (1, K, N) \u7684\u5f97\u5206\u77e9\u9635\u3002 \u5bf9\u4e8e\u6ca1\u6709\u5bf9\u5e94 pair \u7684\u4f4d\u7f6e\u586b\u5145\u4e00\u4e2a\u6781\u5c0f\u503c\u3002 Parameters: pair_scores ( Tensor ) \u2013 (p,) \u6216 (1,1,p) \u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 pair_indices ( Tensor ) \u2013 (p,2) \u6bcf\u884c (i_2d, j_3d) \u8868\u793a\u8be5 score \u5e94\u5199\u5165\u77e9\u9635\u4f4d\u7f6e (i, j)\u3002 K ( int ) \u2013 int \u672c\u5e27 2D \u6846\u6570\u91cf\u4e0a\u9650\u3002 N ( int ) \u2013 int \u672c\u5e27 3D \u6846\u6570\u91cf\u4e0a\u9650\u3002 Returns: score_matrix ( Tensor ) \u2013 (1, K, N) \u5bf9\u5e94\u4f4d\u7f6e\u5199\u5165 pair score\uff0c\u5176\u4f59\u4f4d\u7f6e\u4e3a\u8d1f\u65e0\u7a77\u5c0f\u3002 Source code in Stage4_ScoreAggregation\\operator\\scatter_to_matrix.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 @torch . library . custom_op ( \"clocs::scatter_to_matrix\" , mutates_args = []) def scatter_to_matrix ( pair_scores : torch . Tensor , pair_indices : torch . Tensor , K : int , N : int ) -> torch . Tensor : \"\"\" \u5c06 p \u4e2a pair \u5f97\u5206\u6839\u636e pair_indices \u6563\u5c04\u56de (1, K, N) \u7684\u5f97\u5206\u77e9\u9635\u3002 \u5bf9\u4e8e\u6ca1\u6709\u5bf9\u5e94 pair \u7684\u4f4d\u7f6e\u586b\u5145\u4e00\u4e2a\u6781\u5c0f\u503c\u3002 Args: pair_scores: (p,) \u6216 (1,1,p) \u6bcf\u4e2a pair \u7684\u878d\u5408\u5f97\u5206\u3002 pair_indices: (p,2) \u6bcf\u884c (i_2d, j_3d) \u8868\u793a\u8be5 score \u5e94\u5199\u5165\u77e9\u9635\u4f4d\u7f6e (i, j)\u3002 K: int \u672c\u5e27 2D \u6846\u6570\u91cf\u4e0a\u9650\u3002 N: int \u672c\u5e27 3D \u6846\u6570\u91cf\u4e0a\u9650\u3002 Returns: score_matrix: (1, K, N) \u5bf9\u5e94\u4f4d\u7f6e\u5199\u5165 pair score\uff0c\u5176\u4f59\u4f4d\u7f6e\u4e3a\u8d1f\u65e0\u7a77\u5c0f\u3002 \"\"\" # \u517c\u5bb9\u8f93\u5165\u4e3a (1,1,p) \u6216 (p,) if pair_scores . ndim == 3 : pair_scores = pair_scores . squeeze () score_matrix = torch . full ( ( 1 , K , N ), - 1e7 , device = pair_scores . device ) i_idx = pair_indices [:, 0 ] j_idx = pair_indices [:, 1 ] score_matrix [ 0 , i_idx , j_idx ] = pair_scores return score_matrix","title":"scatter_to_matrix"},{"location":"Stage4_ScoreAggregation/#score_aggregator","text":"","title":"score_aggregator"},{"location":"Stage4_ScoreAggregation/#Stage4_ScoreAggregation.operator.score_aggregator.score_aggregator","text":"\u5bf9 score_matrix (1, K, N) \u5728 2D \u7ef4\u5ea6\u4e0a\u505a\u6700\u5927\u6c60\u5316\uff0c \u4e3a\u6bcf\u4e2a 3D \u6846\u5f97\u5230\u552f\u4e00\u878d\u5408\u5f97\u5206\u3002 Parameters: score_matrix ( Tensor ) \u2013 (1, K, N) \u6765\u81ea scatter_to_matrix \u7684\u5f97\u5206\u77e9\u9635\u3002 Returns: fused_scores ( Tensor ) \u2013 (N) \u6bcf\u4e2a 3D \u6846\u7684\u878d\u5408\u7f6e\u4fe1\u5ea6\uff0c\u53d6 score_matrix \u5728 K \u7ef4\u7684\u6700\u5927\u503c\u3002 Source code in Stage4_ScoreAggregation\\operator\\score_aggregator.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 @torch . library . custom_op ( \"clocs::score_aggregator\" , mutates_args = []) def score_aggregator ( score_matrix : torch . Tensor ) -> torch . Tensor : \"\"\" \u5bf9 score_matrix (1, K, N) \u5728 2D \u7ef4\u5ea6\u4e0a\u505a\u6700\u5927\u6c60\u5316\uff0c \u4e3a\u6bcf\u4e2a 3D \u6846\u5f97\u5230\u552f\u4e00\u878d\u5408\u5f97\u5206\u3002 Args: score_matrix: (1, K, N) \u6765\u81ea scatter_to_matrix \u7684\u5f97\u5206\u77e9\u9635\u3002 Returns: fused_scores: (N) \u6bcf\u4e2a 3D \u6846\u7684\u878d\u5408\u7f6e\u4fe1\u5ea6\uff0c\u53d6 score_matrix \u5728 K \u7ef4\u7684\u6700\u5927\u503c\u3002 \"\"\" # score_matrix: [1, K, N] fused_scores , _ = score_matrix . max ( dim = 1 ) # \u2192 [1, N] # squeeze \u2192 [N] fused_scores = fused_scores . squeeze ( 0 ) return fused_scores","title":"score_aggregator"},{"location":"Stage5_PostProcessing/","text":"Stage 5 \u2014 PostProcessing\uff08\u540e\u5904\u7406\uff09 \u00b6 \u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u57fa\u4e8e\u878d\u5408\u5f97\u5206\u8fdb\u884c\u6700\u7ec8\u7684 3D \u68c0\u6d4b\u6846\u7b5b\u9009 \u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e24\u4e2a\u7b97\u5b50\uff1a iou3d \u8ba1\u7b97 3D IoU\uff0c\u7528\u4e8e NMS \u5224\u65ad\u662f\u5426\u91cd\u53e0\u3002 fused_nms \u57fa\u4e8e IoU3D \u7684 NMS\uff0c\u8f93\u51fa\u6700\u7ec8\u4fdd\u7559\u7684\u68c0\u6d4b\u6846\u7d22\u5f15\u3002 API \u6587\u6863 \u00b6 iou3d \u00b6 iou3d ( boxes_a , boxes_b ) \u00b6 \u8ba1\u7b97\u4e24\u4e2a 3D \u68c0\u6d4b\u6846\u96c6\u5408\u4e4b\u95f4\u7684 IoU3D \u8fd1\u4f3c\u503c\uff1a IoU3D = IoU_BEV \u00d7 IoU_height Parameters: boxes_a ( Tensor ) \u2013 (M, 7) 3D \u6846\u96c6\u5408 A\uff0c\u6bcf\u884c\u683c\u5f0f [x, y, z, w, l, h, yaw]\u3002 boxes_b ( Tensor ) \u2013 (N, 7) 3D \u6846\u96c6\u5408 B\uff0c\u540c\u4e0a\u683c\u5f0f\u3002 Returns: iou_matrix ( Tensor ) \u2013 (M, N) A \u4e2d\u6bcf\u4e2a\u6846\u4e0e B \u4e2d\u6bcf\u4e2a\u6846\u7684 IoU3D\u3002 Source code in Stage5_PostProcessing\\operator\\iou3d.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 @torch . library . custom_op ( \"clocs::iou3d\" , mutates_args = []) def iou3d ( boxes_a : torch . Tensor , boxes_b : torch . Tensor ) -> torch . Tensor : \"\"\" \u8ba1\u7b97\u4e24\u4e2a 3D \u68c0\u6d4b\u6846\u96c6\u5408\u4e4b\u95f4\u7684 IoU3D \u8fd1\u4f3c\u503c\uff1a IoU3D = IoU_BEV \u00d7 IoU_height Args: boxes_a: (M, 7) 3D \u6846\u96c6\u5408 A\uff0c\u6bcf\u884c\u683c\u5f0f [x, y, z, w, l, h, yaw]\u3002 boxes_b: (N, 7) 3D \u6846\u96c6\u5408 B\uff0c\u540c\u4e0a\u683c\u5f0f\u3002 Returns: iou_matrix: (M, N) A \u4e2d\u6bcf\u4e2a\u6846\u4e0e B \u4e2d\u6bcf\u4e2a\u6846\u7684 IoU3D\u3002 \"\"\" # ---- 1. BEV IoU ---- xa1 = boxes_a [:, 0 ] - boxes_a [:, 3 ] / 2 ya1 = boxes_a [:, 1 ] - boxes_a [:, 4 ] / 2 xa2 = boxes_a [:, 0 ] + boxes_a [:, 3 ] / 2 ya2 = boxes_a [:, 1 ] + boxes_a [:, 4 ] / 2 xb1 = boxes_b [:, 0 ] - boxes_b [:, 3 ] / 2 yb1 = boxes_b [:, 1 ] - boxes_b [:, 4 ] / 2 xb2 = boxes_b [:, 0 ] + boxes_b [:, 3 ] / 2 yb2 = boxes_b [:, 1 ] + boxes_b [:, 4 ] / 2 xa1 = xa1 . unsqueeze ( 1 ) ya1 = ya1 . unsqueeze ( 1 ) xa2 = xa2 . unsqueeze ( 1 ) ya2 = ya2 . unsqueeze ( 1 ) xb1 = xb1 . unsqueeze ( 0 ) yb1 = yb1 . unsqueeze ( 0 ) xb2 = xb2 . unsqueeze ( 0 ) yb2 = yb2 . unsqueeze ( 0 ) xx1 = torch . max ( xa1 , xb1 ) yy1 = torch . max ( ya1 , yb1 ) xx2 = torch . min ( xa2 , xb2 ) yy2 = torch . min ( ya2 , yb2 ) inter_w = ( xx2 - xx1 ) . clamp ( min = 0 ) inter_h = ( yy2 - yy1 ) . clamp ( min = 0 ) inter_area = inter_w * inter_h area_a = ( xa2 - xa1 ) * ( ya2 - ya1 ) area_b = ( xb2 - xb1 ) * ( yb2 - yb1 ) bev_iou = inter_area / torch . clamp ( area_a + area_b - inter_area , min = 1e-6 ) # ---- 2. Height IoU ---- za1 = boxes_a [:, 2 ] - boxes_a [:, 5 ] / 2 za2 = boxes_a [:, 2 ] + boxes_a [:, 5 ] / 2 zb1 = boxes_b [:, 2 ] - boxes_b [:, 5 ] / 2 zb2 = boxes_b [:, 2 ] + boxes_b [:, 5 ] / 2 za1 = za1 . unsqueeze ( 1 ) za2 = za2 . unsqueeze ( 1 ) zb1 = zb1 . unsqueeze ( 0 ) zb2 = zb2 . unsqueeze ( 0 ) zz1 = torch . max ( za1 , zb1 ) zz2 = torch . min ( za2 , zb2 ) inter_h = ( zz2 - zz1 ) . clamp ( min = 0 ) h_a = ( za2 - za1 ) h_b = ( zb2 - zb1 ) height_iou = inter_h / torch . clamp ( h_a + h_b - inter_h , min = 1e-6 ) return bev_iou * height_iou fused_nms \u00b6 fused_nms ( boxes_3d , fused_scores , iou_threshold = 0.5 ) \u00b6 \u6839\u636e\u878d\u5408\u5206\u6570 fused_scores \u5bf9 3D \u6846\u6267\u884c IoU3D NMS\uff0c \u5e76\u8f93\u51fa\u6700\u7ec8\u4fdd\u7559\u7684\u6846\u7d22\u5f15\u3002 Parameters: boxes_3d ( Tensor ) \u2013 (N, 7) 3D \u68c0\u6d4b\u6846\u53c2\u6570 [x, y, z, w, l, h, yaw]\u3002 fused_scores ( Tensor ) \u2013 (N) \u6bcf\u4e2a 3D \u6846\u7684\u878d\u5408\u5f97\u5206\u3002 iou_threshold ( float , default: 0.5 ) \u2013 float IoU3D \u9608\u503c\uff0c\u5927\u4e8e\u8be5\u503c\u5219\u5224\u5b9a\u4e3a\u91cd\u53e0\u5e76\u6291\u5236\u3002 Returns: keep_indices ( Tensor ) \u2013 (M) NMS \u540e\u4fdd\u7559\u7684 3D \u6846\u7d22\u5f15\u3002 Source code in Stage5_PostProcessing\\operator\\fused_nms.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 @torch . library . custom_op ( \"clocs::fused_nms\" , mutates_args = []) def fused_nms ( boxes_3d : torch . Tensor , fused_scores : torch . Tensor , iou_threshold : float = 0.5 ) -> torch . Tensor : \"\"\" \u6839\u636e\u878d\u5408\u5206\u6570 fused_scores \u5bf9 3D \u6846\u6267\u884c IoU3D NMS\uff0c \u5e76\u8f93\u51fa\u6700\u7ec8\u4fdd\u7559\u7684\u6846\u7d22\u5f15\u3002 Args: boxes_3d: (N, 7) 3D \u68c0\u6d4b\u6846\u53c2\u6570 [x, y, z, w, l, h, yaw]\u3002 fused_scores: (N) \u6bcf\u4e2a 3D \u6846\u7684\u878d\u5408\u5f97\u5206\u3002 iou_threshold: float IoU3D \u9608\u503c\uff0c\u5927\u4e8e\u8be5\u503c\u5219\u5224\u5b9a\u4e3a\u91cd\u53e0\u5e76\u6291\u5236\u3002 Returns: keep_indices: (M) NMS \u540e\u4fdd\u7559\u7684 3D \u6846\u7d22\u5f15\u3002 \"\"\" scores = fused_scores order = torch . argsort ( scores , descending = True ) keep = [] while order . numel () > 0 : i = order [ 0 ] keep . append ( i . item ()) if order . numel () == 1 : break current = boxes_3d [ i ] . unsqueeze ( 0 ) # (1,7) others = boxes_3d [ order [ 1 :]] # (K,7) # \u2b50 \u4f7f\u7528\u72ec\u7acb\u7b97\u5b50 9\uff1aiou3d ious = torch . ops . clocs . iou3d ( current , others ) . squeeze () # (K,) mask = ious <= iou_threshold order = order [ 1 :][ mask ] return torch . tensor ( keep , device = boxes_3d . device , dtype = torch . long )","title":"Stage5 \u540e\u5904\u7406 (PostProcessing)"},{"location":"Stage5_PostProcessing/#stage-5-postprocessing","text":"\u672c\u9636\u6bb5\u7684\u4f5c\u7528\u662f \u57fa\u4e8e\u878d\u5408\u5f97\u5206\u8fdb\u884c\u6700\u7ec8\u7684 3D \u68c0\u6d4b\u6846\u7b5b\u9009 \u3002 \u672c\u9636\u6bb5\u5305\u542b\u4e24\u4e2a\u7b97\u5b50\uff1a iou3d \u8ba1\u7b97 3D IoU\uff0c\u7528\u4e8e NMS \u5224\u65ad\u662f\u5426\u91cd\u53e0\u3002 fused_nms \u57fa\u4e8e IoU3D \u7684 NMS\uff0c\u8f93\u51fa\u6700\u7ec8\u4fdd\u7559\u7684\u68c0\u6d4b\u6846\u7d22\u5f15\u3002","title":"Stage 5 \u2014 PostProcessing\uff08\u540e\u5904\u7406\uff09"},{"location":"Stage5_PostProcessing/#api","text":"","title":"API \u6587\u6863"},{"location":"Stage5_PostProcessing/#iou3d","text":"","title":"iou3d"},{"location":"Stage5_PostProcessing/#Stage5_PostProcessing.operator.iou3d.iou3d","text":"\u8ba1\u7b97\u4e24\u4e2a 3D \u68c0\u6d4b\u6846\u96c6\u5408\u4e4b\u95f4\u7684 IoU3D \u8fd1\u4f3c\u503c\uff1a IoU3D = IoU_BEV \u00d7 IoU_height Parameters: boxes_a ( Tensor ) \u2013 (M, 7) 3D \u6846\u96c6\u5408 A\uff0c\u6bcf\u884c\u683c\u5f0f [x, y, z, w, l, h, yaw]\u3002 boxes_b ( Tensor ) \u2013 (N, 7) 3D \u6846\u96c6\u5408 B\uff0c\u540c\u4e0a\u683c\u5f0f\u3002 Returns: iou_matrix ( Tensor ) \u2013 (M, N) A \u4e2d\u6bcf\u4e2a\u6846\u4e0e B \u4e2d\u6bcf\u4e2a\u6846\u7684 IoU3D\u3002 Source code in Stage5_PostProcessing\\operator\\iou3d.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 @torch . library . custom_op ( \"clocs::iou3d\" , mutates_args = []) def iou3d ( boxes_a : torch . Tensor , boxes_b : torch . Tensor ) -> torch . Tensor : \"\"\" \u8ba1\u7b97\u4e24\u4e2a 3D \u68c0\u6d4b\u6846\u96c6\u5408\u4e4b\u95f4\u7684 IoU3D \u8fd1\u4f3c\u503c\uff1a IoU3D = IoU_BEV \u00d7 IoU_height Args: boxes_a: (M, 7) 3D \u6846\u96c6\u5408 A\uff0c\u6bcf\u884c\u683c\u5f0f [x, y, z, w, l, h, yaw]\u3002 boxes_b: (N, 7) 3D \u6846\u96c6\u5408 B\uff0c\u540c\u4e0a\u683c\u5f0f\u3002 Returns: iou_matrix: (M, N) A \u4e2d\u6bcf\u4e2a\u6846\u4e0e B \u4e2d\u6bcf\u4e2a\u6846\u7684 IoU3D\u3002 \"\"\" # ---- 1. BEV IoU ---- xa1 = boxes_a [:, 0 ] - boxes_a [:, 3 ] / 2 ya1 = boxes_a [:, 1 ] - boxes_a [:, 4 ] / 2 xa2 = boxes_a [:, 0 ] + boxes_a [:, 3 ] / 2 ya2 = boxes_a [:, 1 ] + boxes_a [:, 4 ] / 2 xb1 = boxes_b [:, 0 ] - boxes_b [:, 3 ] / 2 yb1 = boxes_b [:, 1 ] - boxes_b [:, 4 ] / 2 xb2 = boxes_b [:, 0 ] + boxes_b [:, 3 ] / 2 yb2 = boxes_b [:, 1 ] + boxes_b [:, 4 ] / 2 xa1 = xa1 . unsqueeze ( 1 ) ya1 = ya1 . unsqueeze ( 1 ) xa2 = xa2 . unsqueeze ( 1 ) ya2 = ya2 . unsqueeze ( 1 ) xb1 = xb1 . unsqueeze ( 0 ) yb1 = yb1 . unsqueeze ( 0 ) xb2 = xb2 . unsqueeze ( 0 ) yb2 = yb2 . unsqueeze ( 0 ) xx1 = torch . max ( xa1 , xb1 ) yy1 = torch . max ( ya1 , yb1 ) xx2 = torch . min ( xa2 , xb2 ) yy2 = torch . min ( ya2 , yb2 ) inter_w = ( xx2 - xx1 ) . clamp ( min = 0 ) inter_h = ( yy2 - yy1 ) . clamp ( min = 0 ) inter_area = inter_w * inter_h area_a = ( xa2 - xa1 ) * ( ya2 - ya1 ) area_b = ( xb2 - xb1 ) * ( yb2 - yb1 ) bev_iou = inter_area / torch . clamp ( area_a + area_b - inter_area , min = 1e-6 ) # ---- 2. Height IoU ---- za1 = boxes_a [:, 2 ] - boxes_a [:, 5 ] / 2 za2 = boxes_a [:, 2 ] + boxes_a [:, 5 ] / 2 zb1 = boxes_b [:, 2 ] - boxes_b [:, 5 ] / 2 zb2 = boxes_b [:, 2 ] + boxes_b [:, 5 ] / 2 za1 = za1 . unsqueeze ( 1 ) za2 = za2 . unsqueeze ( 1 ) zb1 = zb1 . unsqueeze ( 0 ) zb2 = zb2 . unsqueeze ( 0 ) zz1 = torch . max ( za1 , zb1 ) zz2 = torch . min ( za2 , zb2 ) inter_h = ( zz2 - zz1 ) . clamp ( min = 0 ) h_a = ( za2 - za1 ) h_b = ( zb2 - zb1 ) height_iou = inter_h / torch . clamp ( h_a + h_b - inter_h , min = 1e-6 ) return bev_iou * height_iou","title":"iou3d"},{"location":"Stage5_PostProcessing/#fused_nms","text":"","title":"fused_nms"},{"location":"Stage5_PostProcessing/#Stage5_PostProcessing.operator.fused_nms.fused_nms","text":"\u6839\u636e\u878d\u5408\u5206\u6570 fused_scores \u5bf9 3D \u6846\u6267\u884c IoU3D NMS\uff0c \u5e76\u8f93\u51fa\u6700\u7ec8\u4fdd\u7559\u7684\u6846\u7d22\u5f15\u3002 Parameters: boxes_3d ( Tensor ) \u2013 (N, 7) 3D \u68c0\u6d4b\u6846\u53c2\u6570 [x, y, z, w, l, h, yaw]\u3002 fused_scores ( Tensor ) \u2013 (N) \u6bcf\u4e2a 3D \u6846\u7684\u878d\u5408\u5f97\u5206\u3002 iou_threshold ( float , default: 0.5 ) \u2013 float IoU3D \u9608\u503c\uff0c\u5927\u4e8e\u8be5\u503c\u5219\u5224\u5b9a\u4e3a\u91cd\u53e0\u5e76\u6291\u5236\u3002 Returns: keep_indices ( Tensor ) \u2013 (M) NMS \u540e\u4fdd\u7559\u7684 3D \u6846\u7d22\u5f15\u3002 Source code in Stage5_PostProcessing\\operator\\fused_nms.py 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 @torch . library . custom_op ( \"clocs::fused_nms\" , mutates_args = []) def fused_nms ( boxes_3d : torch . Tensor , fused_scores : torch . Tensor , iou_threshold : float = 0.5 ) -> torch . Tensor : \"\"\" \u6839\u636e\u878d\u5408\u5206\u6570 fused_scores \u5bf9 3D \u6846\u6267\u884c IoU3D NMS\uff0c \u5e76\u8f93\u51fa\u6700\u7ec8\u4fdd\u7559\u7684\u6846\u7d22\u5f15\u3002 Args: boxes_3d: (N, 7) 3D \u68c0\u6d4b\u6846\u53c2\u6570 [x, y, z, w, l, h, yaw]\u3002 fused_scores: (N) \u6bcf\u4e2a 3D \u6846\u7684\u878d\u5408\u5f97\u5206\u3002 iou_threshold: float IoU3D \u9608\u503c\uff0c\u5927\u4e8e\u8be5\u503c\u5219\u5224\u5b9a\u4e3a\u91cd\u53e0\u5e76\u6291\u5236\u3002 Returns: keep_indices: (M) NMS \u540e\u4fdd\u7559\u7684 3D \u6846\u7d22\u5f15\u3002 \"\"\" scores = fused_scores order = torch . argsort ( scores , descending = True ) keep = [] while order . numel () > 0 : i = order [ 0 ] keep . append ( i . item ()) if order . numel () == 1 : break current = boxes_3d [ i ] . unsqueeze ( 0 ) # (1,7) others = boxes_3d [ order [ 1 :]] # (K,7) # \u2b50 \u4f7f\u7528\u72ec\u7acb\u7b97\u5b50 9\uff1aiou3d ious = torch . ops . clocs . iou3d ( current , others ) . squeeze () # (K,) mask = ious <= iou_threshold order = order [ 1 :][ mask ] return torch . tensor ( keep , device = boxes_3d . device , dtype = torch . long )","title":"fused_nms"}]}